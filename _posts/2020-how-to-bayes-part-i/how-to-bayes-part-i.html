<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">

<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1"/>
  <meta name="generator" content="distill" />

  <style type="text/css">
  /* Hide doc at startup (prevent jankiness while JS renders/transforms) */
  body {
    visibility: hidden;
  }
  </style>

 <!--radix_placeholder_import_source-->
 <!--/radix_placeholder_import_source-->

  <!--radix_placeholder_meta_tags-->
  <title>Practical Bayes Part I</title>
  
  <meta property="description" itemprop="description" content="Practical steps you can take in your Stan journey to deal with issues and explore your models fully."/>
  
  
  <!--  https://schema.org/Article -->
  <meta property="article:published" itemprop="datePublished" content="2020-09-18"/>
  <meta property="article:created" itemprop="dateCreated" content="2020-09-18"/>
  <meta name="article:author" content="Michael Clark"/>
  
  <!--  https://developers.facebook.com/docs/sharing/webmasters#markup -->
  <meta property="og:title" content="Practical Bayes Part I"/>
  <meta property="og:type" content="article"/>
  <meta property="og:description" content="Practical steps you can take in your Stan journey to deal with issues and explore your models fully."/>
  <meta property="og:locale" content="en_US"/>
  
  <!--  https://dev.twitter.com/cards/types/summary -->
  <meta property="twitter:card" content="summary"/>
  <meta property="twitter:title" content="Practical Bayes Part I"/>
  <meta property="twitter:description" content="Practical steps you can take in your Stan journey to deal with issues and explore your models fully."/>
  
  <!--/radix_placeholder_meta_tags-->
  <!--radix_placeholder_rmarkdown_metadata-->
  
  <script type="text/json" id="radix-rmarkdown-metadata">
  {"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["title","description","author","date","preview","output","draft","tags","categories"]}},"value":[{"type":"character","attributes":{},"value":["Practical Bayes Part I"]},{"type":"character","attributes":{},"value":["Practical steps you can take in your Stan journey to deal with issues and explore your models fully.\n"]},{"type":"list","attributes":{},"value":[{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","url"]}},"value":[{"type":"character","attributes":{},"value":["Michael Clark"]},{"type":"character","attributes":{},"value":["https://m-clark.github.io"]}]}]},{"type":"character","attributes":{},"value":["September 18, 2020"]},{"type":"character","attributes":{},"value":["../../img/r_and_stan.png"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["distill::distill_article"]}},"value":[{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["self_contained","toc","css"]}},"value":[{"type":"logical","attributes":{},"value":[false]},{"type":"logical","attributes":{},"value":[true]},{"type":"character","attributes":{},"value":["../../styles.css","https://use.fontawesome.com/releases/v5.14.0/css/all.css"]}]}]},{"type":"logical","attributes":{},"value":[true]},{"type":"character","attributes":{},"value":["tags","taggy"]},{"type":"character","attributes":{},"value":["bayesian"]}]}
  </script>
  <!--/radix_placeholder_rmarkdown_metadata-->
  
  <script type="text/json" id="radix-resource-manifest">
  {"type":"character","attributes":{},"value":["how-to-bayes-part-i_files/bowser-1.9.3/bowser.min.js","how-to-bayes-part-i_files/distill-2.2.21/template.v2.js","how-to-bayes-part-i_files/figure-html5/acf-plot-1.svg","how-to-bayes-part-i_files/figure-html5/area-violin-1.svg","how-to-bayes-part-i_files/figure-html5/area-violin-2.svg","how-to-bayes-part-i_files/figure-html5/eff-plots-1.svg","how-to-bayes-part-i_files/figure-html5/eff-plots-2.svg","how-to-bayes-part-i_files/figure-html5/eff-plots-3.svg","how-to-bayes-part-i_files/figure-html5/model-start-checks-1.svg","how-to-bayes-part-i_files/figure-html5/model-start-checks-show-1.svg","how-to-bayes-part-i_files/figure-html5/model-start-trace-dens-1.svg","how-to-bayes-part-i_files/figure-html5/model-start-x1-1.svg","how-to-bayes-part-i_files/figure-html5/model-start-x1-2.svg","how-to-bayes-part-i_files/figure-html5/model-start-x1-3.svg","how-to-bayes-part-i_files/figure-html5/neff-plot-1.svg","how-to-bayes-part-i_files/figure-html5/pairs-plot-model-start-1.svg","how-to-bayes-part-i_files/figure-html5/pairs-plot-model-start-complex-1.svg","how-to-bayes-part-i_files/figure-html5/par-coord-1.svg","how-to-bayes-part-i_files/figure-html5/rank-plots-1.svg","how-to-bayes-part-i_files/figure-html5/rank-plots-2.svg","how-to-bayes-part-i_files/figure-html5/rhat-plot-1.svg","how-to-bayes-part-i_files/figure-html5/rnorm-trace-dens-1.svg","how-to-bayes-part-i_files/figure-html5/rnorm-trace-dens-2.svg","how-to-bayes-part-i_files/figure-html5/rnorm-trace-plot-1.svg","how-to-bayes-part-i_files/figure-html5/rnorm-trace-plot-2.svg","how-to-bayes-part-i_files/figure-html5/trace-highlight-1.svg","how-to-bayes-part-i_files/jquery-1.11.3/jquery.min.js","how-to-bayes-part-i_files/webcomponents-2.0.0/webcomponents.js"]}
  </script>
  <!--radix_placeholder_navigation_in_header-->
  <!--/radix_placeholder_navigation_in_header-->
  <!--radix_placeholder_distill-->
  
  <style type="text/css">
  
  body {
    background-color: white;
  }
  
  .pandoc-table {
    width: 100%;
  }
  
  .pandoc-table>caption {
    margin-bottom: 10px;
  }
  
  .pandoc-table th:not([align]) {
    text-align: left;
  }
  
  .pagedtable-footer {
    font-size: 15px;
  }
  
  .html-widget {
    margin-bottom: 2.0em;
  }
  
  .l-screen-inset {
    padding-right: 16px;
  }
  
  .l-screen .caption {
    margin-left: 10px;
  }
  
  .shaded {
    background: rgb(247, 247, 247);
    padding-top: 20px;
    padding-bottom: 20px;
    border-top: 1px solid rgba(0, 0, 0, 0.1);
    border-bottom: 1px solid rgba(0, 0, 0, 0.1);
  }
  
  .shaded .html-widget {
    margin-bottom: 0;
    border: 1px solid rgba(0, 0, 0, 0.1);
  }
  
  .shaded .shaded-content {
    background: white;
  }
  
  .text-output {
    margin-top: 0;
    line-height: 1.5em;
  }
  
  .hidden {
    display: none !important;
  }
  
  d-article {
    padding-bottom: 30px;
  }
  
  d-appendix {
    padding-top: 30px;
  }
  
  d-article>p>img {
    width: 100%;
  }
  
  d-article iframe {
    border: 1px solid rgba(0, 0, 0, 0.1);
    margin-bottom: 2.0em;
    width: 100%;
  }
  
  figure img.external {
    background: white;
    border: 1px solid rgba(0, 0, 0, 0.1);
    box-shadow: 0 1px 8px rgba(0, 0, 0, 0.1);
    padding: 18px;
    box-sizing: border-box;
  }
  
  /* CSS for table of contents */
  
  .d-toc {
    color: rgba(0,0,0,0.8);
    font-size: 0.8em;
    line-height: 1em;
  }
  
  .d-toc-header {
    font-size: 0.6rem;
    font-weight: 400;
    color: rgba(0, 0, 0, 0.5);
    text-transform: uppercase;
    margin-top: 0;
    margin-bottom: 1.3em;
  }
  
  .d-toc a {
    border-bottom: none;
  }
  
  .d-toc ul {
    padding-left: 0;
  }
  
  .d-toc li>ul {
    padding-top: 0.8em;
    padding-left: 16px;
    margin-bottom: 0.6em;
  }
  
  .d-toc ul,
  .d-toc li {
    list-style-type: none;
  }
  
  .d-toc li {
    margin-bottom: 0.9em;
  }
  
  .d-toc-separator {
    margin-top: 20px;
    margin-bottom: 2em;
  }
  
  .d-article-with-toc {
    border-top: none;
    padding-top: 0;
  }
  
  
  
  /* Tweak code blocks (note that this CSS is repeated above in an injection
     into the d-code shadow dom) */
  
  d-code {
    overflow-x: auto !important;
  }
  
  pre.d-code code.d-code {
    padding-left: 10px;
    font-size: 12px;
    border-left: 2px solid rgba(0,0,0,0.1);
  }
  
  pre.text-output {
  
    font-size: 12px;
    color: black;
    background: none;
    font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
    text-align: left;
    white-space: pre;
    word-spacing: normal;
    word-break: normal;
    word-wrap: normal;
    line-height: 1.5;
  
    -moz-tab-size: 4;
    -o-tab-size: 4;
    tab-size: 4;
  
    -webkit-hyphens: none;
    -moz-hyphens: none;
    -ms-hyphens: none;
    hyphens: none;
  }
  
  @media(min-width: 768px) {
  
  d-code {
    overflow-x: visible !important;
  }
  
  pre.d-code code.d-code  {
      padding-left: 18px;
      font-size: 14px;
  }
  pre.text-output {
    font-size: 14px;
  }
  }
  
  /* Figure */
  
  .figure {
    position: relative;
    margin-bottom: 2.5em;
    margin-top: 1.5em;
  }
  
  .figure img {
    width: 100%;
  }
  
  .figure .caption {
    color: rgba(0, 0, 0, 0.6);
    font-size: 12px;
    line-height: 1.5em;
  }
  
  .figure img.external {
    background: white;
    border: 1px solid rgba(0, 0, 0, 0.1);
    box-shadow: 0 1px 8px rgba(0, 0, 0, 0.1);
    padding: 18px;
    box-sizing: border-box;
  }
  
  .figure .caption a {
    color: rgba(0, 0, 0, 0.6);
  }
  
  .figure .caption b,
  .figure .caption strong, {
    font-weight: 600;
    color: rgba(0, 0, 0, 1.0);
  }
  
  
  
  /* Tweak 1000px media break to show more text */
  
  @media(min-width: 1000px) {
    .base-grid,
    distill-header,
    d-title,
    d-abstract,
    d-article,
    d-appendix,
    distill-appendix,
    d-byline,
    d-footnote-list,
    d-citation-list,
    distill-footer {
      grid-template-columns: [screen-start] 1fr [page-start kicker-start] 80px [middle-start] 50px [text-start kicker-end] 65px 65px 65px 65px 65px 65px 65px 65px [text-end gutter-start] 65px [middle-end] 65px [page-end gutter-end] 1fr [screen-end];
      grid-column-gap: 16px;
    }
  
    .grid {
      grid-column-gap: 16px;
    }
  
    d-article {
      font-size: 1.06rem;
      line-height: 1.7em;
    }
    figure .caption, .figure .caption, figure figcaption {
      font-size: 13px;
    }
  }
  
  @media(min-width: 1180px) {
    .base-grid,
    distill-header,
    d-title,
    d-abstract,
    d-article,
    d-appendix,
    distill-appendix,
    d-byline,
    d-footnote-list,
    d-citation-list,
    distill-footer {
      grid-template-columns: [screen-start] 1fr [page-start kicker-start] 60px [middle-start] 60px [text-start kicker-end] 60px 60px 60px 60px 60px 60px 60px 60px [text-end gutter-start] 60px [middle-end] 60px [page-end gutter-end] 1fr [screen-end];
      grid-column-gap: 32px;
    }
  
    .grid {
      grid-column-gap: 32px;
    }
  }
  
  
  /* Get the citation styles for the appendix (not auto-injected on render since
     we do our own rendering of the citation appendix) */
  
  d-appendix .citation-appendix,
  .d-appendix .citation-appendix {
    font-size: 11px;
    line-height: 15px;
    border-left: 1px solid rgba(0, 0, 0, 0.1);
    padding-left: 18px;
    border: 1px solid rgba(0,0,0,0.1);
    background: rgba(0, 0, 0, 0.02);
    padding: 10px 18px;
    border-radius: 3px;
    color: rgba(150, 150, 150, 1);
    overflow: hidden;
    margin-top: -12px;
    white-space: pre-wrap;
    word-wrap: break-word;
  }
  
  
  /* Social footer */
  
  .social_footer {
    margin-top: 30px;
    margin-bottom: 0;
    color: rgba(0,0,0,0.67);
  }
  
  .disqus-comments {
    margin-right: 30px;
  }
  
  .disqus-comment-count {
    border-bottom: 1px solid rgba(0, 0, 0, 0.4);
    cursor: pointer;
  }
  
  #disqus_thread {
    margin-top: 30px;
  }
  
  .article-sharing a {
    border-bottom: none;
    margin-right: 8px;
  }
  
  .article-sharing a:hover {
    border-bottom: none;
  }
  
  .sidebar-section.subscribe {
    font-size: 12px;
    line-height: 1.6em;
  }
  
  .subscribe p {
    margin-bottom: 0.5em;
  }
  
  
  .article-footer .subscribe {
    font-size: 15px;
    margin-top: 45px;
  }
  
  
  .sidebar-section.custom {
    font-size: 12px;
    line-height: 1.6em;
  }
  
  .custom p {
    margin-bottom: 0.5em;
  }
  
  
  /* Improve display for browsers without grid (IE/Edge <= 15) */
  
  .downlevel {
    line-height: 1.6em;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", Arial, sans-serif;
    margin: 0;
  }
  
  .downlevel .d-title {
    padding-top: 6rem;
    padding-bottom: 1.5rem;
  }
  
  .downlevel .d-title h1 {
    font-size: 50px;
    font-weight: 700;
    line-height: 1.1em;
    margin: 0 0 0.5rem;
  }
  
  .downlevel .d-title p {
    font-weight: 300;
    font-size: 1.2rem;
    line-height: 1.55em;
    margin-top: 0;
  }
  
  .downlevel .d-byline {
    padding-top: 0.8em;
    padding-bottom: 0.8em;
    font-size: 0.8rem;
    line-height: 1.8em;
  }
  
  .downlevel .section-separator {
    border: none;
    border-top: 1px solid rgba(0, 0, 0, 0.1);
  }
  
  .downlevel .d-article {
    font-size: 1.06rem;
    line-height: 1.7em;
    padding-top: 1rem;
    padding-bottom: 2rem;
  }
  
  
  .downlevel .d-appendix {
    padding-left: 0;
    padding-right: 0;
    max-width: none;
    font-size: 0.8em;
    line-height: 1.7em;
    margin-bottom: 0;
    color: rgba(0,0,0,0.5);
    padding-top: 40px;
    padding-bottom: 48px;
  }
  
  .downlevel .footnotes ol {
    padding-left: 13px;
  }
  
  .downlevel .base-grid,
  .downlevel .distill-header,
  .downlevel .d-title,
  .downlevel .d-abstract,
  .downlevel .d-article,
  .downlevel .d-appendix,
  .downlevel .distill-appendix,
  .downlevel .d-byline,
  .downlevel .d-footnote-list,
  .downlevel .d-citation-list,
  .downlevel .distill-footer,
  .downlevel .appendix-bottom,
  .downlevel .posts-container {
    padding-left: 40px;
    padding-right: 40px;
  }
  
  @media(min-width: 768px) {
    .downlevel .base-grid,
    .downlevel .distill-header,
    .downlevel .d-title,
    .downlevel .d-abstract,
    .downlevel .d-article,
    .downlevel .d-appendix,
    .downlevel .distill-appendix,
    .downlevel .d-byline,
    .downlevel .d-footnote-list,
    .downlevel .d-citation-list,
    .downlevel .distill-footer,
    .downlevel .appendix-bottom,
    .downlevel .posts-container {
    padding-left: 150px;
    padding-right: 150px;
    max-width: 900px;
  }
  }
  
  .downlevel pre code {
    display: block;
    border-left: 2px solid rgba(0, 0, 0, .1);
    padding: 0 0 0 20px;
    font-size: 14px;
  }
  
  .downlevel code, .downlevel pre {
    color: black;
    background: none;
    font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
    text-align: left;
    white-space: pre;
    word-spacing: normal;
    word-break: normal;
    word-wrap: normal;
    line-height: 1.5;
  
    -moz-tab-size: 4;
    -o-tab-size: 4;
    tab-size: 4;
  
    -webkit-hyphens: none;
    -moz-hyphens: none;
    -ms-hyphens: none;
    hyphens: none;
  }
  
  </style>
  
  <script type="application/javascript">
  
  function is_downlevel_browser() {
    if (bowser.isUnsupportedBrowser({ msie: "12", msedge: "16"},
                                   window.navigator.userAgent)) {
      return true;
    } else {
      return window.load_distill_framework === undefined;
    }
  }
  
  // show body when load is complete
  function on_load_complete() {
  
    // set body to visible
    document.body.style.visibility = 'visible';
  
    // force redraw for leaflet widgets
    if (window.HTMLWidgets) {
      var maps = window.HTMLWidgets.findAll(".leaflet");
      $.each(maps, function(i, el) {
        var map = this.getMap();
        map.invalidateSize();
        map.eachLayer(function(layer) {
          if (layer instanceof L.TileLayer)
            layer.redraw();
        });
      });
    }
  
    // trigger 'shown' so htmlwidgets resize
    $('d-article').trigger('shown');
  }
  
  function init_distill() {
  
    init_common();
  
    // create front matter
    var front_matter = $('<d-front-matter></d-front-matter>');
    $('#distill-front-matter').wrap(front_matter);
  
    // create d-title
    $('.d-title').changeElementType('d-title');
  
    // create d-byline
    var byline = $('<d-byline></d-byline>');
    $('.d-byline').replaceWith(byline);
  
    // create d-article
    var article = $('<d-article></d-article>');
    $('.d-article').wrap(article).children().unwrap();
  
    // move posts container into article
    $('.posts-container').appendTo($('d-article'));
  
    // create d-appendix
    $('.d-appendix').changeElementType('d-appendix');
  
    // create d-bibliography
    var bibliography = $('<d-bibliography></d-bibliography>');
    $('#distill-bibliography').wrap(bibliography);
  
    // flag indicating that we have appendix items
    var appendix = $('.appendix-bottom').children('h3').length > 0;
  
    // replace citations with <d-cite>
    $('.citation').each(function(i, val) {
      appendix = true;
      var cites = $(this).attr('data-cites').split(" ");
      var dt_cite = $('<d-cite></d-cite>');
      dt_cite.attr('key', cites.join());
      $(this).replaceWith(dt_cite);
    });
    // remove refs
    $('#refs').remove();
  
    // replace footnotes with <d-footnote>
    $('.footnote-ref').each(function(i, val) {
      appendix = true;
      var href = $(this).attr('href');
      var id = href.replace('#', '');
      var fn = $('#' + id);
      var fn_p = $('#' + id + '>p');
      fn_p.find('.footnote-back').remove();
      var text = fn_p.html();
      var dtfn = $('<d-footnote></d-footnote>');
      dtfn.html(text);
      $(this).replaceWith(dtfn);
    });
    // remove footnotes
    $('.footnotes').remove();
  
    $('h1.appendix, h2.appendix').each(function(i, val) {
      $(this).changeElementType('h3');
    });
    $('h3.appendix').each(function(i, val) {
      var id = $(this).attr('id');
      $('.d-toc a[href="#' + id + '"]').parent().remove();
      appendix = true;
      $(this).nextUntil($('h1, h2, h3')).addBack().appendTo($('d-appendix'));
    });
  
    // show d-appendix if we have appendix content
    $("d-appendix").css('display', appendix ? 'grid' : 'none');
  
    // replace code blocks with d-code
    $('pre>code').each(function(i, val) {
      var code = $(this);
      var pre = code.parent();
      var clz = "";
      var language = pre.attr('class');
      if (language) {
        // map unknown languages to "clike" (without this they just dissapear)
        if ($.inArray(language, ["bash", "clike", "css", "go", "html",
                                 "javascript", "js", "julia", "lua", "markdown",
                                 "markup", "mathml", "python", "svg", "xml"]) == -1)
          language = "clike";
        language = ' language="' + language + '"';
        var dt_code = $('<d-code block' + language + clz + '></d-code>');
        dt_code.text(code.text());
        pre.replaceWith(dt_code);
      } else {
        code.addClass('text-output').unwrap().changeElementType('pre');
      }
    });
  
    // localize layout chunks to just output
    $('.layout-chunk').each(function(i, val) {
  
      // capture layout
      var layout = $(this).attr('data-layout');
  
      // apply layout to markdown level block elements
      var elements = $(this).children().not('d-code, pre.text-output, script');
      elements.each(function(i, el) {
        var layout_div = $('<div class="' + layout + '"></div>');
        if (layout_div.hasClass('shaded')) {
          var shaded_content = $('<div class="shaded-content"></div>');
          $(this).wrap(shaded_content);
          $(this).parent().wrap(layout_div);
        } else {
          $(this).wrap(layout_div);
        }
      });
  
  
      // unwrap the layout-chunk div
      $(this).children().unwrap();
    });
  
    // load distill framework
    load_distill_framework();
  
    // wait for window.distillRunlevel == 4 to do post processing
    function distill_post_process() {
  
      if (!window.distillRunlevel || window.distillRunlevel < 4)
        return;
  
      // hide author/affiliations entirely if we have no authors
      var front_matter = JSON.parse($("#distill-front-matter").html());
      var have_authors = front_matter.authors && front_matter.authors.length > 0;
      if (!have_authors)
        $('d-byline').addClass('hidden');
  
      // table of contents
      if (have_authors) // adjust border if we are in authors
        $('.d-toc').parent().addClass('d-article-with-toc');
  
      // strip links that point to #
      $('.authors-affiliations').find('a[href="#"]').removeAttr('href');
  
      // hide elements of author/affiliations grid that have no value
      function hide_byline_column(caption) {
        $('d-byline').find('h3:contains("' + caption + '")').parent().css('visibility', 'hidden');
      }
  
      // affiliations
      var have_affiliations = false;
      for (var i = 0; i<front_matter.authors.length; ++i) {
        var author = front_matter.authors[i];
        if (author.affiliation !== "&nbsp;") {
          have_affiliations = true;
          break;
        }
      }
      if (!have_affiliations)
        $('d-byline').find('h3:contains("Affiliations")').css('visibility', 'hidden');
  
      // published date
      if (!front_matter.publishedDate)
        hide_byline_column("Published");
  
      // document object identifier
      var doi = $('d-byline').find('h3:contains("DOI")');
      var doi_p = doi.next().empty();
      if (!front_matter.doi) {
        // if we have a citation and valid citationText then link to that
        if ($('#citation').length > 0 && front_matter.citationText) {
          doi.html('Citation');
          $('<a href="#citation"></a>')
            .text(front_matter.citationText)
            .appendTo(doi_p);
        } else {
          hide_byline_column("DOI");
        }
      } else {
        $('<a></a>')
           .attr('href', "https://doi.org/" + front_matter.doi)
           .html(front_matter.doi)
           .appendTo(doi_p);
      }
  
       // change plural form of authors/affiliations
      if (front_matter.authors.length === 1) {
        var grid = $('.authors-affiliations');
        grid.children('h3:contains("Authors")').text('Author');
        grid.children('h3:contains("Affiliations")').text('Affiliation');
      }
  
      // inject pre code styles (can't do this with a global stylesheet b/c a shadow root is used)
      $('d-code').each(function(i, val) {
        var style = document.createElement('style');
        style.innerHTML = 'pre code { padding-left: 10px; font-size: 12px; border-left: 2px solid rgba(0,0,0,0.1); } ' +
                          '@media(min-width: 768px) { pre code { padding-left: 18px; font-size: 14px; } }';
        if (this.shadowRoot)
          this.shadowRoot.appendChild(style);
      });
  
      // move appendix-bottom entries to the bottom
      $('.appendix-bottom').appendTo('d-appendix').children().unwrap();
      $('.appendix-bottom').remove();
  
      // clear polling timer
      clearInterval(tid);
  
      // show body now that everything is ready
      on_load_complete();
    }
  
    var tid = setInterval(distill_post_process, 50);
    distill_post_process();
  
  }
  
  function init_downlevel() {
  
    init_common();
  
     // insert hr after d-title
    $('.d-title').after($('<hr class="section-separator"/>'));
  
    // check if we have authors
    var front_matter = JSON.parse($("#distill-front-matter").html());
    var have_authors = front_matter.authors && front_matter.authors.length > 0;
  
    // manage byline/border
    if (!have_authors)
      $('.d-byline').remove();
    $('.d-byline').after($('<hr class="section-separator"/>'));
    $('.d-byline a').remove();
  
    // remove toc
    $('.d-toc-header').remove();
    $('.d-toc').remove();
    $('.d-toc-separator').remove();
  
    // move appendix elements
    $('h1.appendix, h2.appendix').each(function(i, val) {
      $(this).changeElementType('h3');
    });
    $('h3.appendix').each(function(i, val) {
      $(this).nextUntil($('h1, h2, h3')).addBack().appendTo($('.d-appendix'));
    });
  
  
    // inject headers into references and footnotes
    var refs_header = $('<h3></h3>');
    refs_header.text('References');
    $('#refs').prepend(refs_header);
  
    var footnotes_header = $('<h3></h3');
    footnotes_header.text('Footnotes');
    $('.footnotes').children('hr').first().replaceWith(footnotes_header);
  
    // move appendix-bottom entries to the bottom
    $('.appendix-bottom').appendTo('.d-appendix').children().unwrap();
    $('.appendix-bottom').remove();
  
    // remove appendix if it's empty
    if ($('.d-appendix').children().length === 0)
      $('.d-appendix').remove();
  
    // prepend separator above appendix
    $('.d-appendix').before($('<hr class="section-separator" style="clear: both"/>'));
  
    // trim code
    $('pre>code').each(function(i, val) {
      $(this).html($.trim($(this).html()));
    });
  
    // move posts-container right before article
    $('.posts-container').insertBefore($('.d-article'));
  
    $('body').addClass('downlevel');
  
    on_load_complete();
  }
  
  
  function init_common() {
  
    // jquery plugin to change element types
    (function($) {
      $.fn.changeElementType = function(newType) {
        var attrs = {};
  
        $.each(this[0].attributes, function(idx, attr) {
          attrs[attr.nodeName] = attr.nodeValue;
        });
  
        this.replaceWith(function() {
          return $("<" + newType + "/>", attrs).append($(this).contents());
        });
      };
    })(jQuery);
  
    // prevent underline for linked images
    $('a > img').parent().css({'border-bottom' : 'none'});
  
    // mark non-body figures created by knitr chunks as 100% width
    $('.layout-chunk').each(function(i, val) {
      var figures = $(this).find('img, .html-widget');
      if ($(this).attr('data-layout') !== "l-body") {
        figures.css('width', '100%');
      } else {
        figures.css('max-width', '100%');
        figures.filter("[width]").each(function(i, val) {
          var fig = $(this);
          fig.css('width', fig.attr('width') + 'px');
        });
  
      }
    });
  
    // auto-append index.html to post-preview links in file: protocol
    // and in rstudio ide preview
    $('.post-preview').each(function(i, val) {
      if (window.location.protocol === "file:")
        $(this).attr('href', $(this).attr('href') + "index.html");
    });
  
    // get rid of index.html references in header
    if (window.location.protocol !== "file:") {
      $('.distill-site-header a[href]').each(function(i,val) {
        $(this).attr('href', $(this).attr('href').replace("index.html", "./"));
      });
    }
  
    // add class to pandoc style tables
    $('tr.header').parent('thead').parent('table').addClass('pandoc-table');
    $('.kable-table').children('table').addClass('pandoc-table');
  
    // add figcaption style to table captions
    $('caption').parent('table').addClass("figcaption");
  
    // initialize posts list
    if (window.init_posts_list)
      window.init_posts_list();
  
    // implmement disqus comment link
    $('.disqus-comment-count').click(function() {
      window.headroom_prevent_pin = true;
      $('#disqus_thread').toggleClass('hidden');
      if (!$('#disqus_thread').hasClass('hidden')) {
        var offset = $(this).offset();
        $(window).resize();
        $('html, body').animate({
          scrollTop: offset.top - 35
        });
      }
    });
  }
  
  document.addEventListener('DOMContentLoaded', function() {
    if (is_downlevel_browser())
      init_downlevel();
    else
      window.addEventListener('WebComponentsReady', init_distill);
  });
  
  </script>
  
  <!--/radix_placeholder_distill-->
  <script src="how-to-bayes-part-i_files/jquery-1.11.3/jquery.min.js"></script>
  <script src="how-to-bayes-part-i_files/bowser-1.9.3/bowser.min.js"></script>
  <script src="how-to-bayes-part-i_files/webcomponents-2.0.0/webcomponents.js"></script>
  <script src="how-to-bayes-part-i_files/distill-2.2.21/template.v2.js"></script>
  <!--radix_placeholder_site_in_header-->
  <!--/radix_placeholder_site_in_header-->

  <link rel="stylesheet" href="../../styles.css" type="text/css"/>
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.14.0/css/all.css" type="text/css"/>

</head>

<body>

<!--radix_placeholder_front_matter-->

<script id="distill-front-matter" type="text/json">
{"title":"Practical Bayes Part I","description":"Practical steps you can take in your Stan journey to deal with issues and explore your models fully.","authors":[{"author":"Michael Clark","authorURL":"https://m-clark.github.io","affiliation":"&nbsp;","affiliationURL":"#"}],"publishedDate":"2020-09-18T00:00:00.000-04:00","citationText":"Clark, 2020"}
</script>

<!--/radix_placeholder_front_matter-->
<!--radix_placeholder_navigation_before_body-->
<!--/radix_placeholder_navigation_before_body-->
<!--radix_placeholder_site_before_body-->
<!--/radix_placeholder_site_before_body-->

<div class="d-title">
<h1>Practical Bayes Part I</h1>
<p><p>Practical steps you can take in your Stan journey to deal with issues and explore your models fully.</p></p>
</div>

<div class="d-byline">
  Michael Clark <a href="https://m-clark.github.io" class="uri">https://m-clark.github.io</a> 
  
<br/>September 18, 2020
</div>

<div class="d-article">
<h3 class="d-toc-header">Table of Contents</h3>
<nav class="d-toc" id="TOC">
<ul>
<li><a href="#overview">Overview</a></li>
<li><a href="#the-stated-problem">The Stated Problem</a></li>
<li><a href="#audience">Audience</a></li>
<li><a href="#outline">Outline</a></li>
<li><a href="#installation-issues">Installation issues</a><ul>
<li><a href="#mac">Mac</a></li>
<li><a href="#windows">Windows</a></li>
<li><a href="#linux">Linux</a></li>
<li><a href="#other-programming-languages-besides-r">Other programming languages besides R</a></li>
</ul></li>
<li><a href="#example-data">Example data</a></li>
<li><a href="#essential-steps-for-practical-modeling">Essential Steps for Practical Modeling</a></li>
<li><a href="#warnings-what-they-mean-and-what-to-do-about-them">Warnings, What They Mean, and What to do About Them</a><ul>
<li><a href="#rhat-effective-sample-size">Rhat &amp; Effective Sample Size</a></li>
<li><a href="#bfmi-low">BFMI low</a></li>
<li><a href="#tree-depth">Tree Depth</a></li>
<li><a href="#divergent-transitions">Divergent Transitions</a></li>
<li><a href="#other-messages">Other messages</a></li>
</ul></li>
<li><a href="#other-issues">Other Issues</a><ul>
<li><a href="#but-its-slow">But it’s slow!</a></li>
<li><a href="#shinystan">shinystan</a></li>
</ul></li>
<li><a href="#summary-the-practical-approach-to-diagnostics">Summary: The Practical Approach to Diagnostics</a></li>
<li><a href="#resources">Resources</a></li>
</ul>
</nav>
<hr class="d-toc-separator"/>
<h2 id="overview">Overview</h2>
<div class="layout-chunk" data-layout="l-body">

</div>
<p><img src='../../img/r_and_stan.png' style="display:block; margin: 0 auto; width: 50%"></p>
<p><br></p>
<p>Bayesian analysis takes some getting used to, but offers great advantages once you get into it. While it can be difficult to get started, it typically should not take much to repeat an analysis one is already familiar with, say a standard regression with some (common) additional complexity like a binary outcome, interactions, random effects, etc. What’s great is that <span style="color: #b2001d;"><strong>Stan</strong></span>, a programming language for Bayesian analysis, has come a long way and provides a means for (relatively) fast computation. What’s more, applied analysts do not need to know the Stan programming language to do common and even notably complicated models. Packages like rstanarm and brms, coupled with additional tools like bayesplot, tidybayes, and more, make getting and exploring results even easier than the R packages one already uses.</p>
<p>One of the advantages of doing Bayesian analysis with these tools is that there are many ways to diagnose model issues, problems, and failures. This is great! Traditional analysis can often be notably more difficult in this regard, or at least typically requires more hands-on approaches, and often there can be serious model deficiencies without much notification or, if there is, there might be little one can do about it. On the other hand, current Bayesian packages are providing diagnostic information as a default part of results, have ready visualizations to explore issues, and more.</p>
<h2 id="the-stated-problem">The Stated Problem</h2>
<div style="text-align: center">
<p><i class="far fa-question-circle fa-5x" style="padding: 20px"></i></p>
</div>
<p>This is all great in general. However, in consulting I see a consistent issue among clients starting out with Bayesian analysis and Stan packages. Someone has a standard model, e.g. a basic regression or mixed model, but is getting problematic warnings, messages, or errors. When they look up how to solve this problem, the documentation, forums, and other outlets, while great resources for the initiated, generally overwhelm newer and/or more applied users, as they are too technical, assume a great deal of background knowledge, are even underexplained (especially in the case of interpreting visualizations), and even suggest things that aren’t typically possible (e.g. getting better data/model). What seems straightforward to an advanced user or developer may not be even close to that for most applied analysts, and many of them (again, my experience) are left a bit deflated by the whole process.</p>
<p>In the beginning of Stan’s ascension, the majority of people using Stan/rstan were more technically inclined, coded in Stan directly, and, when problems arose, they were willing to do a lot of extra work to solve the problems (reading articles, developing pseudo-expertise with various techniques, and more). But tools like rstanarm and brms make running Bayesian models as <a href="https://m-clark.github.io/easy-bayes/">easy to do</a> as using base R functions and other non-Bayesian packages, and as Bayesian analysis has become more widely used, accepted, and presented, this has opened the Bayesian approach to practically anyone that wants to do it.</p>
<p>I personally don’t think one needs to be an expert in Bayesian analysis to enjoy its benefits for common models, even if difficulties come up. Nor do I think an exhaustive search through forums, technical articles, and more are necessary to have to do for issues that arise often. So this is an attempt at a one-stop shop for dealing with the most common issues that arise, interpreting results of diagnostics, and summarizing the options one can take.</p>
<h2 id="audience">Audience</h2>
<div style="text-align: center">
<p><i class="fas fa-users fa-5x" style="padding: 20px"></i><i class="fas fa-users fa-5x"></i><i class="fas fa-users fa-5x"></i></p>
</div>
<p>Here is the presumed audience for this post:</p>
<ul>
<li>Wants to bayes</li>
<li>Is not going to code anything in Stan directly</li>
<li>Is not a statistician, nor desires technical insights about Bayesian analysis (at least not yet!)</li>
<li>Is already having to learn a new tool/functions/possibly a whole system of inference</li>
<li>Has probably never used the control argument for any model</li>
</ul>
<p>While you can do a Bayesian analysis just for the heck of it, you really need to understand a few key ideas to take advantage of what it offers. Some things you do need to know in order to use it on a basic level:</p>
<ul>
<li>The distributions: priors, likelihood, posterior, posterior predictive</li>
<li>Iterative sampling to estimate parameters. Even a cursory understanding of maximum likelihood would probably be enough.</li>
</ul>
<p>You can obtain this basic info from my document <a href="m-clark.github.io/bayesian-basics/">Bayesian Basics</a>.</p>
<h2 id="outline">Outline</h2>
<p>Here is what we’re going to do:</p>
<ul>
<li>Discuss the most common problems</li>
<li>Explain conceptually what they indicate</li>
<li>Provide quick solutions that should work most of the time</li>
<li>Outline a practical approach for future endeavors (Part II)</li>
</ul>
<h2 id="installation-issues">Installation issues</h2>
<p>Your first hurdle is installation, so let’s start there. Applied users will use rstanarm, brms, or other higher level interfaces to the Stan programming language. These tools use Stan, but Stan itself requires compilation to C++. This means that to run a basic regression with brms, you’ll likely be depending on multiple languages and packages for it to work.</p>
<p><span class="math inline">\(\rightarrow\quad\)</span> package with basic R code (brms, rstanarm)</p>
<p><span class="math inline">\(\quad\rightarrow\quad\)</span> Model is translated to Stan (or use rstan with Stan code)</p>
<p><span class="math inline">\(\quad\quad\rightarrow\quad\)</span> Compiled to C++ (requires compiler)</p>
<p>In general, installing the package you want to use will install the appropriate dependencies, and that should be enough as far as your interactive R part goes. In some cases it may not be. If you have issues, it’s maybe best to install rstan first, then your package of choice. Issues beyond that make indicate an issue with the compiler, at which point you’ll want to consult the forums.</p>
<h3 id="mac">Mac</h3>
<p>Mac’s Catalina OS has been a problematic release to say the least. There was a period of time where Stan wasn’t viable for many users without extensive workarounds, and even now, issues seemingly still arise with every update to Catalina. This is not specific to Stan, or R, by the way<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>. Then R 4.0 came along and helped some things, but also resulted in new issues That said, the Stan community have been excellent at helping people here. My own luck of late has been better, but I just assume at this point that if I update Catalina or update the packages, I may have to work through some problem.</p>
<p>Here are some discussions on the Stan forums for getting through installation problems. Unfortunately a couple of these threads are now nearly a year old, and weren’t closed, so some are still posting to them. This means that any discussion prior to R 4.0 can be ignored, and you probably only want to skip towards the end of those discussions for the relevant parts.</p>
<ul>
<li><a href="https://discourse.mc-stan.org/t/dealing-with-catalina/11285/">Dealing with Catalina I</a> First post Oct 2019</li>
<li><a href="https://discourse.mc-stan.org/t/dealing-with-catalina-ii/11802/">Dealing with Catalina II</a> First post Nov 2019</li>
<li><a href="https://discourse.mc-stan.org/t/dealing-with-catalina-iii/12731/">Dealing with Catalina III</a> First post Jan 2020</li>
<li><a href="https://discourse.mc-stan.org/t/dealing-with-catalina-iv/13502/">Dealing with Catalina IV</a> First post Mar 2020</li>
</ul>
<h3 id="windows">Windows</h3>
<p>I rarely had installation issues on Windows’ releases, though haven’t had to use it lately. It does require <a href="https://cran.r-project.org/bin/windows/Rtools/">rtools</a> to be installed, which is good to install for R with Windows anyway. If you are starting out, I would install it, then rstan, then your package of choice (e.g. brms). Again though, if you have issues, the Stan community will be very helpful.</p>
<p><a href="https://discourse.mc-stan.org/search?q=windows">Search Windows Issues on Stan Forums</a></p>
<h3 id="linux">Linux</h3>
<p>I’ve only used Stan with Linux in a cluster computing environment. Applied users also need cluster computing on occasion, it’s just that the problems will likely require IT support in that case. I generally have not had issues, but it’s not something I’ve done recently, and I don’t have any basic Linux desktop experience. Again though, plenty of Stan folks are willing to help.</p>
<p><a href="https://discourse.mc-stan.org/search?q=Linux">Search Linux Issues on Stan Forums</a></p>
<h3 id="other-programming-languages-besides-r">Other programming languages besides R</h3>
<p>If you’re using Stan with Python, Stata, Julia, etc., then you’re using the Stan language directly, and you’re likely already very familiar with the forums and dealing with a variety of issues. That’s not to say that you won’t find something useful here, it’s just that I have nothing to offer you regarding those platforms specifically.</p>
<h2 id="example-data">Example data</h2>
<div style="text-align: center">
<p><i class="fas fa-database fa-5x" style="padding: 20px"></i></p>
</div>
<p><br></p>
<p>To start out, I’m going to create some data for us to run some basic models with. To make things interesting, the true underlying model has categorical and continuous covariates, interactions, nonlinear relationships, random effects (observations are clustered in groups), and some variables are collinear. You can skip these details if uninterested, but note that we will be purposely using under- and over-fitted models relative to this one to see what happens.</p>
<div class="layout-chunk" data-layout="l-body">
<pre class="r"><code>
library(tidyverse)

create_data &lt;- function( N = 1000, ng = 100, seed = 1234) {
  
  set.seed(seed)
  
  X_mm = cbind(
    # a standard binary
    binary_1 = sample(0:1, N, replace = TRUE),                      
    # a relatively rare categorical
    binary_2 = sample(0:1, N, replace = TRUE, prob = c(.05, .95)),  
    # two partly collinear numeric
    mvtnorm::rmvnorm(N,
                     mean = rep(0, 3),
                     sigma = lazerhawk::create_corr(runif(3, max = .6)))
  )
  
  X_mm = cbind(
    # intercept
    1,
    X_mm,
    # a quadratic effect
    scale(poly(X_mm[,5], 3))[,2:3],
    # interaction of binary variables
    X_mm[,1]*X_mm[,2], 
    # interaction of binary 2 with numeric 1
    X_mm[,2]*X_mm[,3]
  )
  
  # add intercept
  colnames(X_mm) = c(
    &#39;Intercept&#39;,
    &#39;b1&#39;,
    &#39;b2&#39;,
    &#39;x1&#39;,
    &#39;x2&#39;,
    &#39;x3&#39;,
    &#39;x3_sq&#39;,
    &#39;x3_cub&#39;,
    &#39;b1_b2&#39;,
    &#39;b2_x1&#39;
  )
  
  # coefficients
  beta = c(
    3.0,   # intercept
     .3,   # b1
    -.3,   # b2
     .5,   # x1
     .0,   # x2
     .3 ,  # x3 
     .3,   # x3_sq
    -.2,   # x3_cub
     .5,   # b1_b2 
    -.5    # b2_x1
  )
  
  # create target variable/linear predictor
  y = X_mm %*% beta
  
  # add random effect
  groups = sort(sample(1:ng, N, replace = T))
  
  re = rnorm(ng, sd = .5)[groups]  # re sd = .5
  
  # add re and residual noise
  y = y + re + rnorm(N)
  y = cbind(y, groups)
  colnames(y) = c(&#39;y&#39;, &#39;group&#39;)
  
  as_tibble(cbind(X_mm, y))
}</code></pre>
</div>
<div class="layout-chunk" data-layout="l-body">

</div>
<p>If you want to check that the parameters are recovered, run the following.</p>
<div class="layout-chunk" data-layout="l-body">
<pre class="r"><code>
dat = create_data(N = 10000)

mod = lme4::lmer(y ~ . -group + (1|group), data.frame(dat[,-1]))

mixedup::summarise_model(mod, ci = FALSE)</code></pre>
</div>
<p>We do not need as much data for our purposes so we’ll set the total sample size to 1000. We’ll drop unnecessary columns, and also make our binary covariates explicit factors, which will make things easier when want to visualize grouped effects later.</p>
<div class="layout-chunk" data-layout="l-body">
<pre class="r"><code>
# create the primary data frame

main_df = 
  create_data(N = 1000) %&gt;% 
  as_tibble() %&gt;% 
  select(group, b1:x3, y) %&gt;% 
  mutate(
    b1 = factor(b1),   # will help with visuals
    b2 = factor(b2)
  )

main_df</code></pre>
<pre><code>
# A tibble: 1,000 x 7
   group b1    b2         x1      x2     x3     y
   &lt;dbl&gt; &lt;fct&gt; &lt;fct&gt;   &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;
 1     1 1     1      0.155   0.145  -1.84   4.01
 2     1 1     1     -0.356   1.33   -0.604  3.84
 3     1 1     1     -0.329   0.488  -0.441  3.37
 4     1 1     1      1.08   -1.50    1.00   3.80
 5     1 0     1     -0.563  -1.07   -0.150  1.81
 6     1 1     1     -0.0694 -0.229  -0.387  4.54
 7     1 0     1      0.374   0.606   2.04   4.17
 8     1 0     1      2.06   -0.266   0.168  1.83
 9     2 0     0      0.278   0.0559  1.04   1.58
10     2 1     0      0.184   0.230   0.174  3.56
# … with 990 more rows</code></pre>
</div>
<h2 id="essential-steps-for-practical-modeling">Essential Steps for Practical Modeling</h2>
<div style="text-align: center">
<p><i class="fa fa-shoe-prints fa-5x" style="padding: 20px"></i></p>
</div>
<p><br></p>
<p>Once data is in hand there are basic steps to take for a practical modeling approach with Stan tools.</p>
<h5 id="use-standarddefault-priors-for-the-model">Use standard/default priors for the model</h5>
<ul>
<li>For common regression models, normal or student t for the (fixed effect) coefficients. You will have to explicitly set this if using brms.</li>
<li>(half) student-t for variances. Defaults are usually fine.</li>
<li>Otherwise, look at the <a href="https://github.com/stan-dev/stan/wiki/Prior-Choice-Recommendations">recommendations</a>.</li>
</ul>
<h5 id="build-models-in-increasing-complexity">Build models in increasing complexity</h5>
<ul>
<li>Never start with the ‘final’ model, if the fitting has issues with simpler models, things will only get worse with more complex models.</li>
<li>Getting model settings squared away earlier will save time later (e.g. setting number of iterations, other options).</li>
</ul>
<h5 id="examine-convergence-via-rhat-ess-visualization">Examine convergence via Rhat, ESS, visualization</h5>
<ul>
<li>If you run the model and get no warnings or messages, you are okay to proceed to summarize and visualize it. Any remaining issues, e.g. poor prediction, are likely to not have obvious solutions other than things like getting better data, revising theory, etc.</li>
<li>Diagnostic plots are the main tool to diagnose issues that come from warnings.</li>
</ul>
<h5 id="examine-model-effectiveness-visually">Examine model effectiveness visually</h5>
<ul>
<li>There are entire packages at your disposal for visualizing model results such as <span class="pack" style="">bayesplot</span>, tidybayes, etc. However, standard plots can be called from rstanarm or brms functions, which are wrappers for bayesplot functions.</li>
<li>Posterior predictive checks are a fundamental part of Bayesian analysis.</li>
<li>Avoid using <a href="https://statmodeling.stat.columbia.edu/2019/09/10/i-hate-bayes-factors-when-theyre-used-for-null-hypothesis-significance-testing/">bayes factors</a>, at least as a way to substitute the null hypothesis test you would have done in the non-Bayesian setting, but also for other technical reasons.</li>
</ul>
<h5 id="compare-models-using-loo-posterior-probabilities-of-models">Compare models using loo, posterior probabilities of models</h5>
<ul>
<li>Compare models via predictive capabilities (leave-one-out approaches).</li>
<li>There is no ‘best’ model in Bayesian approach or otherwise. Consider model averaging for final predictions.</li>
<li>It is not necessary to lean on simpler models, though it may make things easier to do so.</li>
</ul>
<p>Assuming you have no problems in the above process, you have more or less fulfilled the basic requirements to do more standard analyses in Bayesian form. Great!</p>
<h2 id="warnings-what-they-mean-and-what-to-do-about-them">Warnings, What They Mean, and What to do About Them</h2>
<div style="text-align: center">
<p><i class="fas fa-exclamation-triangle fa-5x" style="padding: 20px"></i></p>
</div>
<p>Of course, if it was always that easy, we wouldn’t be posting this. There are a few warnings that you’re bound to come across at some point in modeling with the Stan ecosystem. We’ll cover these, as well as the most common solutions.</p>
<p>Primary reference: <a href="https://mc-stan.org/misc/warnings.html">Brief Guide to Stan’s Warnings</a></p>
<h3 id="rhat-effective-sample-size">Rhat &amp; Effective Sample Size</h3>
<p>We will start with a simple standard regression model that we know is not adequate. We will use default priors<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a> and run very few iterations.</p>
<div class="layout-chunk" data-layout="l-body">
<pre class="r"><code>
# no priors, no complexity, all default settings, few iterations
library(brms)

model_start_100 = brm(
  y ~ b1 + b2 + x1 + x2 + x3, 
  data = main_df,
  iter = 100,
  verbose = F
)</code></pre>
<pre><code>
Warning: Bulk Effective Samples Size (ESS) is too low, indicating posterior means and medians may be unreliable.
Running the chains for more iterations may help. See
http://mc-stan.org/misc/warnings.html#bulk-ess</code></pre>
<pre><code>
Warning: Tail Effective Samples Size (ESS) is too low, indicating posterior variances and tail quantiles may be unreliable.
Running the chains for more iterations may help. See
http://mc-stan.org/misc/warnings.html#tail-ess</code></pre>
</div>
<div class="layout-chunk" data-layout="l-body">
<pre class="r"><code>
summary(model_start_100)</code></pre>
<pre><code>
 Family: gaussian 
  Links: mu = identity; sigma = identity 
Formula: y ~ b1 + b2 + x1 + x2 + x3 
   Data: main_df (Number of observations: 1000) 
Samples: 4 chains, each with iter = 100; warmup = 50; thin = 1;
         total post-warmup samples = 200

Population-Level Effects: 
          Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
Intercept     2.73      0.17     2.39     3.00 1.04       89       68
b11           0.84      0.07     0.71     0.96 1.00      158      138
b21          -0.14      0.17    -0.42     0.21 1.03       89       98
x1            0.02      0.04    -0.06     0.09 1.00      271      182
x2           -0.03      0.04    -0.11     0.05 0.99      360      195
x3            0.28      0.03     0.21     0.34 0.99      281      193

Family Specific Parameters: 
      Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
sigma     1.11      0.02     1.07     1.16 1.01      175      182

Samples were drawn using sampling(NUTS). For each parameter, Bulk_ESS
and Tail_ESS are effective sample size measures, and Rhat is the potential
scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
</div>
<p>The warnings about Rhat and effective sample size (ESS) are likely to pop up if you use default iterations for more complex models. They mostly regard the efficiency of the sampling process, and whether you have enough samples to have stable parameter estimates. Ideally Rhat is close to 1.0, and ESS is?</p>
<p>The fix for these warnings is usually simple, just let the model run for more iterations. The default is 2000 iterations with warmup half of that. Warmup iterations are not used in calculation of parameter estimates, so you can just increase the number of iterations relative to the warmup, or increase both by only increasing the <code>iter</code> argument.</p>
<p>As an example we can look at our short run model. If we plot the estimated values across each iteration for each chain, called a <em>trace plot</em>, we can see that the chains could be mixing better, but only if you are used to looking at these things.</p>
<div class="layout-chunk" data-layout="l-body">
<pre class="r"><code>
# plot(model_start_100, par = &#39;x1&#39;) # examine specific parameters
mcmc_plot(model_start_100, pars = c(&#39;b11&#39;, &#39;b2&#39;, &#39;x1&#39;), type = &#39;combo&#39;)</code></pre>
<p><img src="how-to-bayes-part-i_files/figure-html5/model-start-trace-dens-1.svg" width="624" style="display: block; margin: auto;" /></p>
</div>
<p>To see what you would expect, just plot a series from a normal distribution.</p>
<div class="layout-chunk" data-layout="l-body">
<pre class="r"><code>
ggplot2::qplot(x = 1:1000,
               y = rnorm(1000),
               geom = &#39;line&#39;)</code></pre>
<p><img src="how-to-bayes-part-i_files/figure-html5/rnorm-trace-dens-1.svg" width="50%" style="display: block; margin: auto;" /></p>
<pre class="r"><code>
ggplot2::qplot(x = rnorm(1000), geom = &#39;density&#39;)</code></pre>
<p><img src="how-to-bayes-part-i_files/figure-html5/rnorm-trace-dens-2.svg" width="50%" style="display: block; margin: auto;" /></p>
</div>
<p>Other plots that might be of interest allow us to look at the same things from a different perspective or break out results by each chain.</p>
<div class="layout-chunk" data-layout="l-body">
<pre class="r"><code>
mcmc_plot(model_start_100, type = &#39;areas&#39;)</code></pre>
<p><img src="how-to-bayes-part-i_files/figure-html5/area-violin-1.svg" width="624" style="display: block; margin: auto;" /></p>
<pre class="r"><code>
mcmc_plot(model_start_100, type = &#39;violin&#39;)</code></pre>
<p><img src="how-to-bayes-part-i_files/figure-html5/area-violin-2.svg" width="624" style="display: block; margin: auto;" /></p>
</div>
<p>While things seem okay, what happens if we single out a particular chain, we might think otherwise. In this case, the intercept and b2 coefficients may be problematic.</p>
<div class="layout-chunk" data-layout="l-body">
<pre class="r"><code>
mcmc_plot(model_start_100, highlight = 2, type = &#39;trace_highlight&#39;)</code></pre>
<p><img src="how-to-bayes-part-i_files/figure-html5/trace-highlight-1.svg" width="624" style="display: block; margin: auto;" /></p>
</div>
<p>Some suggest to look at <em>rank plots</em> instead of traditional traceplots. Really, all we’ve changed is looking for something ‘fuzzy’ to looking for ‘approximately uniform’, so my opinion is that it’s not much of an improvement visually or intuitively. In general, histograms, which are variants of bar charts, are rarely an improvement for any visualization. If you do use it, you can use an overlay approach to see if the ranks are mixing, but this looks a lot like what I’d be looking for from a traceplot.</p>
<div class="layout-chunk" data-layout="l-body">
<pre class="r"><code>
mcmc_plot(model_start_100, type = &#39;rank_hist&#39;)</code></pre>
<p><img src="how-to-bayes-part-i_files/figure-html5/rank-plots-1.svg" width="624" style="display: block; margin: auto;" /></p>
<pre class="r"><code>
mcmc_plot(model_start_100, type = &#39;rank_overlay&#39;)</code></pre>
<p><img src="how-to-bayes-part-i_files/figure-html5/rank-plots-2.svg" width="624" style="display: block; margin: auto;" /></p>
</div>
<h4 id="some-technical-details">Some technical details</h4>
<h5 id="rhat">Rhat</h5>
<p>The <span class="math inline">\(\hat{R}\)</span> statistic measures the ratio of the average variance of samples within each chain to the variance of the pooled samples across chains; if all chains are at equilibrium, these will be the same and Rhat will be 1.0. If the chains have not converged to a common distribution, the Rhat statistic will be greater than one.</p>
<p><strong>What we want</strong>: values near 1.0 and less than 1.05</p>
<div class="layout-chunk" data-layout="l-body">
<pre class="r"><code>
mcmc_plot(model_start_100, type = &#39;rhat&#39;)  # &gt; 1.05 problematic</code></pre>
<p><img src="how-to-bayes-part-i_files/figure-html5/rhat-plot-1.svg" width="624" style="display: block; margin: auto;" /></p>
</div>
<h5 id="ess">ESS</h5>
<p>Effective sample size is an estimate of the effective number of independent draws from the posterior distribution of the parameter of interest. Because the draws within a chain are not independent if there is autocorrelation, the effective sample size will be smaller than the total number of iterations.</p>
<ul>
<li><em>Bulk ESS</em>: ESS for the mean/median</li>
<li><em>Tail ESS</em>: ESS for the 5% and 95% quantiles. Tail-ESS can help diagnose problems due to different scales of the chains and slow mixing in the tails.</li>
</ul>
<p><strong>What we want</strong>: ESS &gt; 10% percent of total posterior samples for sure, but &gt; 50% is best. Bulk-ESS &gt; 100 times the number of chains.</p>
<div class="layout-chunk" data-layout="l-body">
<pre class="r"><code>
mcmc_plot(model_start_100, type = &#39;neff&#39;)  # &lt; .1 problem</code></pre>
<p><img src="how-to-bayes-part-i_files/figure-html5/neff-plot-1.svg" width="624" style="display: block; margin: auto;" /></p>
</div>
<h5 id="trace-plot">Trace plot</h5>
<p>Shows the estimated parameter values at each iteration. In general you would like a random bouncing around an average value.</p>
<p><strong>What we want</strong>: Something like random normal draws over a series. ‘Grassy’, ‘Fuzzy caterpillar’</p>
<h5 id="rank-plot">Rank plot</h5>
<p>From bayesplot helpfile:</p>
<blockquote>
<p>Whereas traditional trace plots visualize how the chains mix over the course of sampling, rank histograms visualize how the values from the chains mix together in terms of ranking. An ideal plot would show the rankings mixing or overlapping in a uniform distribution.</p>
</blockquote>
<p>See Vehtari et al. (2019) for details.</p>
<p><strong>What we want</strong>: Uniform distribution, Good mixing of lines for overlay.</p>
<h5 id="acf-plot">ACF plot</h5>
<p>The acf, or autocorrelation function plot (see next section), is exactly the same thing you’d visualize for any time series. It is a plot of a series correlation with specific lags of itself. Autocorrelation does not bias estimates, but increased autocorrelation may be more inefficient/slower. At lag zero, the series estimates are perfectly correlated with themselves, so that’s where the plot usually starts.</p>
<p><strong>What we want</strong>: Quick drop off, but not really that important.</p>
<div class="layout-chunk" data-layout="l-body">
<pre class="r"><code>
mcmc_plot(model_start_100, type = &#39;acf&#39;)  # &lt; .1 problem</code></pre>
<p><img src="how-to-bayes-part-i_files/figure-html5/acf-plot-1.svg" width="624" style="display: block; margin: auto;" /></p>
</div>
<h5 id="efficiency-plots">Efficiency plots</h5>
<p>I have seen these often recommended, but I’m not aware of a package does them. Aki Vehtari has supplied a walkthrough and some code, but there isn’t really documentation for the functions, and they likely won’t work outside of rstan objects, or at least I had limited success with brms. Furthermore, these are getting into weeds that are beyond what I’d expect applied users to be wading through.</p>
<p><a href="https://avehtari.github.io/rhat_ess/rhat_ess.html">Vehtari’s walkthrough</a></p>
<p><a href="https://github.com/avehtari/rhat_ess/blob/master/code/monitornew.R">Code for functions</a></p>
<p><a href="https://github.com/avehtari/rhat_ess/blob/master/code/monitorplot.R">Code for plots</a></p>
<h4 id="solution-for-rhatess-warnings">Solution for Rhat/ESS warnings</h4>
<p>The general solution to Rhat and ESS warnings is simply to do more iterations. To keep posterior samples and model objects from becoming unwieldy in size<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a>, consider thinning also. Thinning will also reduce autocorrelation, as the draws retained after thinning are not as correlated with one another as successive draws would be.</p>
<div class="layout-chunk" data-layout="l-body">
<pre class="r"><code>
brm(model)  # default with 4 chains, 1000 warmup 2000 total = 4*(2000 - 1000) = 4000 post-warmup draws
brm(model, warmup = 2000, iter = 4000)  # 4*(4000 - 2000) = 8000 posterior draws
brm(model, warmup = 2000, iter = 4000, thin = 8)  # 4*(4000 - 2000)/8 = 1000 posterior draws</code></pre>
</div>
<h3 id="bfmi-low">BFMI low</h3>
<p>You may see a warning that says some number of chains had an estimated Bayesian Fraction of Missing Information (BFMI) that was too low. This implies that the adaptation phase of the Markov Chains did not turn out well, and those chains likely did not explore the posterior distribution efficiently. For more details on this diagnostic, you can see <a href="https://arxiv.org/abs/1604.00695">Betancourt’s article</a>, but this will almost surely be too technical for many applied and even more advanced users.</p>
<p>In this case, the problem here is often remedied by just adding more iterations as before. I typically keep to 1000 posterior samples, which makes for nicer visualizations of distributions without creating relatively large model objects.</p>
<div class="layout-chunk" data-layout="l-body">
<pre class="r"><code>
model_start = update(model_start_100, warmup = 2000, iter = 2250) # 1000 posterior draws</code></pre>
</div>
<p>We no longer have any warnings, and even one of our more problematic coefficients looks fine now.</p>
<div class="layout-chunk" data-layout="l-body">
<pre class="r"><code>
summary(model_start)</code></pre>
<pre><code>
 Family: gaussian 
  Links: mu = identity; sigma = identity 
Formula: y ~ b1 + b2 + x1 + x2 + x3 
   Data: main_df (Number of observations: 1000) 
Samples: 4 chains, each with iter = 2250; warmup = 2000; thin = 1;
         total post-warmup samples = 1000

Population-Level Effects: 
          Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
Intercept     2.74      0.20     2.36     3.14 1.00     1753      867
b11           0.83      0.07     0.69     0.96 1.01     1477      596
b21          -0.14      0.20    -0.55     0.24 1.00     1855      772
x1            0.03      0.04    -0.04     0.10 1.01     1392      757
x2           -0.03      0.04    -0.11     0.05 1.00     1829      756
x3            0.28      0.03     0.21     0.35 1.00     1417      659

Family Specific Parameters: 
      Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
sigma     1.11      0.02     1.06     1.15 1.01     1684      562

Samples were drawn using sampling(NUTS). For each parameter, Bulk_ESS
and Tail_ESS are effective sample size measures, and Rhat is the potential
scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
<pre class="r"><code>
plot(model_start, par = &#39;b2&#39;)</code></pre>
<p><img src="how-to-bayes-part-i_files/figure-html5/model-start-checks-show-1.svg" width="624" style="display: block; margin: auto;" /></p>
</div>
<h4 id="solution-for-low-bfmi">Solution for low BFMI</h4>
<p>If there aren’t other serious problems, add more iterations. In some cases, switching from a heavy-tailed prior (e.g. student t) to normal would be helpful, but this typically would involve having to write Stan code directly to <a href="https://mc-stan.org/docs/2_18/stan-users-guide/reparameterization-section.html">reparameterize the model</a>. Otherwise, you will approach it similarly to the problem of <a href="#divergent-transitions">divergent transitions</a>.</p>
<h3 id="tree-depth">Tree Depth</h3>
<p>Tree depth is a more technical warning that has to do with the details of Hamiltonian Monte Carlo. Practically speaking:</p>
<blockquote>
<p>Lack of convergence and hitting the maximum number of leapfrog steps (equivalently maximum tree depth) are indicative of improper posteriors ~ Stan User Guide</p>
</blockquote>
<p>Sometimes you’ll get a warning about hitting maximum tree depth, and without getting overly technical, the fix is easy enough. Just set the maximum higher.</p>
<h4 id="solution-for-max-tree-depth">Solution for max tree depth</h4>
<p>Use the control argument to increase the value beyond 10.</p>
<div class="layout-chunk" data-layout="l-body">
<pre class="r"><code>
model_update_treedepth = update(
  model,
  warmup = 1750,
  iter = 2000,
  control = list(max_tree_depth = 15)
)</code></pre>
</div>
<h3 id="divergent-transitions">Divergent Transitions</h3>
<p><em>Divergent transitions</em> are a technical issue that indicates something may be notably wrong with the data or model (<a href="https://mc-stan.org/docs/2_24/reference-manual/divergent-transitions.html">technical details</a>). They indicate that the sampling process has ‘gone off the rails’ and the iteration’s results and anything based on them (i.e. subsequent draws, parameter estimates) can’t be trusted.</p>
<p>Why might this happen?</p>
<ul>
<li>insufficient data for the model’s complexity</li>
<li>poor model</li>
<li>high collinearity</li>
<li>improper priors</li>
<li>separability (logistic regression)</li>
</ul>
<p>As an example, I’ll make a relatively complex model with only a small random sample of the data, and use very few warmups.</p>
<div class="layout-chunk" data-layout="l-body">
<pre class="r"><code>
model_problem = brm(
  y ~ b1*b2*x1 + x2*b2 + x3*b2 + (1 + x1 + b2|group),
  data   = main_df %&gt;% slice_sample(prop = .1),
  cores  = 4,
  warmup = 10,
  iter   = 1010,
  thin   = 4,
  seed   = 12
)</code></pre>
<pre><code>
Compiling Stan program...</code></pre>
<pre><code>
Trying to compile a simple C file</code></pre>
<pre><code>
Start sampling</code></pre>
<pre><code>
Warning: There were 3 divergent transitions after warmup. See
http://mc-stan.org/misc/warnings.html#divergent-transitions-after-warmup
to find out why this is a problem and how to eliminate them.</code></pre>
<pre><code>
Warning: Examine the pairs() plot to diagnose sampling problems</code></pre>
<pre><code>
Warning: The largest R-hat is 3, indicating chains have not mixed.
Running the chains for more iterations may help. See
http://mc-stan.org/misc/warnings.html#r-hat</code></pre>
<pre><code>
Warning: Bulk Effective Samples Size (ESS) is too low, indicating posterior means and medians may be unreliable.
Running the chains for more iterations may help. See
http://mc-stan.org/misc/warnings.html#bulk-ess</code></pre>
<pre><code>
Warning: Tail Effective Samples Size (ESS) is too low, indicating posterior variances and tail quantiles may be unreliable.
Running the chains for more iterations may help. See
http://mc-stan.org/misc/warnings.html#tail-ess</code></pre>
</div>
<p>So what do we do in this case? Well let’s start with visual inspection.</p>
<h4 id="example-pairs-plot">Example: Pairs plot</h4>
<p>A diagnostic tool that is typically suggested to look at with divergent transitions is the <span class="emph" style="">pairs plot</span>. It is just a scatterplot matrix of the parameters estimates (and log posterior value), but it suffers from a few issues. The plot is slow to render even with few parameters, and simply too unwieldy to use for many typical modeling situations. If you somehow knew in advance which parameters were causing issues, you could narrow it down by only looking at those parameters. But if you knew which parameters were the problem, you wouldn’t need the pairs plot.</p>
<p>Another issue is that it isn’t what you think it is. The upper diagonal is not just the flipped coordinates of the lower diagonal like every other scatterplot matrix you’ve seen. The chains are split such that half are used for the above diagonal plots, and the other for the lower.</p>
<blockquote>
<p>In this case, plots below the diagonal will contain realizations that are below the median of the indicated variable (or are zero in the case of "divergent__“), and plots above the diagonal will contain realizations that are greater than or equal to the median of the indicated variable (or are one in the case of”divergent__"). ~ documentation for <span class="func" style="">mcmc_pairs</span></p>
</blockquote>
<p>I suspect this won’t mean much to applied users. Another issue is that you could change how the chains are split and it could potentially dramatically change the how the pattern of divergent transitions looks. But the gist is, that if your red points show up on the upper diagonal, changing the <code>adapt_delta</code> argument may help, otherwise it likely won’t. In the cases I see for myself and clients, increasing <code>adapt_delta</code> rarely helps in either case, but it doesn’t hurt to try.</p>
<p>Let’s take a look anyway. I’ll use <code>hex</code> bins instead of standard points because the point plots have no transparency, don’t take standard arguments to update, and generally require more effort to figure out how to manipulate than I want to spend on a diagnostic plot. In addition, we’ll use a density plot on the diagonal, instead of the poorer option of histogram.</p>
<div class="layout-chunk" data-layout="l-body">
<pre class="r"><code>
mcmc_plot(
  model_problem,
  pars = c(&#39;b_b11&#39;, &#39;b_b21&#39;, &#39;sigma&#39;),
  type = &#39;pairs&#39;,
  diag_fun = &#39;dens&#39;,
  off_diag_fun = &#39;hex&#39;,
  fixed = TRUE
)</code></pre>
<p><img src="how-to-bayes-part-i_files/figure-html5/pairs-plot-model-start-complex-1.svg" width="624" style="display: block; margin: auto;" /></p>
</div>
<div class="layout-chunk" data-layout="l-body">

</div>
<p>With problematic cases, what you might see on the off-diagonal plots is some sort of ‘funneling’, which would indicate where the sampler is getting stuck in the parameter space. However, this visual notion isn’t defined well, as it may be happening without being obvious, displaying just a bump<a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a>. But you’ll also regularly see correlated parameters, including nonlinearly related ones, but it’s unclear whether these might be a problem as well.</p>
<p>For the main model the pairs plot for all parameters took several seconds to produce, and even with the hex option still looks pretty poor. It shows the intercept and <code>b2</code> parameters to be notably correlated, but there is no obvious reason for this.</p>
<div class="layout-chunk" data-layout="l-body">
<pre class="r"><code>
mcmc_plot(
  model_start,
  type = &#39;pairs&#39;,
  off_diag_fun = &#39;hex&#39;,
  diag_fun = &#39;dens&#39;
)</code></pre>
<p><img src="how-to-bayes-part-i_files/figure-html5/pairs-plot-model-start-1.svg" width="624" style="display: block; margin: auto;" /></p>
</div>
<h4 id="example-parallel-coordinates-plot">Example: Parallel Coordinates Plot</h4>
<p>It is also suggested to look at parallel coordinates<a href="#fn5" class="footnote-ref" id="fnref5" role="doc-noteref"><sup>5</sup></a>. The order of these is arbitrary, but can definitely be highly influential in your perception of them. Also, unless everything is on similar scales, they aren’t going to be very useful, but even if you scale your data in some fashion, the estimates given divergent transitions may be notably beyond a reasonable scale. With our model, it was actually difficult to get divergent transitions, and sometimes, with a overly complex model with almost no warmup and only 15% of the data, I could get a result with no warnings whatsoever.</p>
<p>As near as I can tell, we’d be looking for knots where the highlighted lines converge to a point. Likewise in our pairs plot, we’d be looking for a pattern among the divergences. If these aren’t the case we’re told that the divergences are probably false positives, which seems counter to the suggestion that even 1 divergent transition</p>
<div class="layout-chunk" data-layout="l-body">
<pre class="r"><code>
library(bayesplot)

mcmc_parcoord(
  model_problem,
  pars = vars(matches(&#39;^b&#39;)),
  size = .25, 
  alpha = .01,
  np = nuts_params(model_problem),  # without this div trans won&#39;t be highlighted
  np_style = parcoord_style_np(
    div_color = &quot;#ff5500&quot;,
    div_size = 1,
    div_alpha = .1
  )
)</code></pre>
<p><img src="how-to-bayes-part-i_files/figure-html5/par-coord-1.svg" width="624" style="display: block; margin: auto;" /></p>
</div>
<h4 id="solution-for-divergent-transitions">Solution for divergent transitions</h4>
<p>Use the control argument to increase <code>adapt_delta</code> to .99<a href="#fn6" class="footnote-ref" id="fnref6" role="doc-noteref"><sup>6</sup></a> and let your model have more warmup/total iterations.</p>
<div class="layout-chunk" data-layout="l-body">
<pre class="r"><code>
model = brm(..., control = list(adapt_delta = .99))</code></pre>
</div>
<p>Aside from that you will have to look more deeply, including issues with priors, model specification, and more. I find this typically comes from poor data (e.g. not scaled) combined with a complex model, and beyond that, the priors may need to be amended.</p>
<h4 id="more">More</h4>
<p><a href="https://discourse.mc-stan.org/t/divergent-transitions-a-primer/17099" class="uri">https://discourse.mc-stan.org/t/divergent-transitions-a-primer/17099</a></p>
<h3 id="other-messages">Other messages</h3>
<p>Certain builds of rstan for certain settings (e.g. specific operating systems) will often have warnings or other messages. Oftentimes it looks like a bunch of gobbledygook, which is typically something happening at the C++ level. If your model runs and produces output, you can typically ignore most cases. However, even then you should look it up on the forums just to be sure.</p>
<h4 id="parser-warnings">Parser warnings</h4>
<p>Parser warnings are either a deprecation warning or another more serious kind (Jacobian). The latter will not happen if you’re using higher level interfaces rather than programming in Stan directly. The other kind, deprecation warnings, are not something you can do anything about, but the developer of the package will likely need to make minor changes to the code to avoid them. I’ve never seen parser warnings from using rstanarm or brms.</p>
<h4 id="compilation-warnings">Compilation warnings</h4>
<p>Compiler warnings happen regularly and indicate something going on at the compiler level, typically that something in Stan is being compiled but not used. You can ignore these.</p>
<h4 id="solutions-for-other-messages">Solutions for other messages</h4>
<p>If you are using a package to interface with Stan and not having an issue with the model (i.e. it runs), these messages can largely be ignored.</p>
<h2 id="other-issues">Other Issues</h2>
<h3 id="but-its-slow">But it’s slow!</h3>
<p>The main other problem people seem to be concerned with is the speed of the analysis. If you have a lot of data, or more the point, a lot of parameters, your model can be very slow. For standard models with rstanarm and brms, there may be no real benefit if you have millions of data points and simpler models. If your model is only taking a couple minutes, then you really have nothing to complain about- watch some youtube or something while it runs. If your model takes on the order of hours, work with less data or simpler models, until you have your modeling code, plots, etc. squared away</p>
<h4 id="solutions-for-a-slow-model">Solutions for a slow model</h4>
<ul>
<li>Scale the data: for any model, bayesian or otherwise, scaling the data will usually result in a more manageable estimation process.</li>
<li>Use more informative priors: why explore areas of the posterior that aren’t going to lead to plausible results?</li>
<li>Possibly use less iterations if no other issues.</li>
<li>If possible, work with less data or simpler models until ready for the real deal.</li>
<li>If possible, work with a different version of the model that can still answer the question of interest. For example, if an ordinal model is causing a lot of issues, and you’re not interested in category specific probabilities, just treat it as numeric<a href="#fn7" class="footnote-ref" id="fnref7" role="doc-noteref"><sup>7</sup></a>.</li>
</ul>
<h3 id="shinystan">shinystan</h3>
<p>The shinystan is a package that makes exploring model diagnostics actually fun! Using launch_shinystan opens a browser window, providing interactive visualizations to help you see what’s going on with your model. You can look at many of the previous plots, plus a few others we haven’t shown.</p>
<p>Unfortunately the documentation in the browser doesn’t really tell you what to look for in these plots. The glossary contains information that is likely overly technical for applied or new users, and if there is a problem, there’s not really a whole lot to go on. In addition, some plots are just poor (e.g. trying to assess whether overlapping histograms are similar), or are probably only useful if you have very obvious problem (e.g. lots of divergent transitions). As an example, consider the tree depth plots. What would not be good here?</p>
<p><img src="../../img/howtobayes/max_treedepth.png" style="display:block; margin: 0 auto;"></p>
<p>The documentation tells you the value should be somewhere between 0 and whatever <code>max_treedepth</code> is set at. If they are large, the documentation states the problem could be due to different things, but the solutions are to either reparameterize of the model (probably not possible unless using Stan code directly), or just increase the value. It doesn’t seem to tell you what those plots are supposed to look like, and unfortunately that renders them as not very useful. The divergence and energy plots are similarly underexplained. Many refer users to Betancourt’s wonderful articles on the details, but these are far too technical for those not already steeped in the approach, and even then<a href="#fn8" class="footnote-ref" id="fnref8" role="doc-noteref"><sup>8</sup></a>.</p>
<p>All that said, luckily there is a nice walkthrough if you do have a hankering to go down that path. This provides more details on the statistics and on what you should be looking for in the visualizations.</p>
<ul>
<li>Resource: <a href="https://mc-stan.org/bayesplot/articles/visual-mcmc-diagnostics.html">Visual MCMC diagnostics</a></li>
</ul>
<h2 id="summary-the-practical-approach-to-diagnostics">Summary: The Practical Approach to Diagnostics</h2>
<p>For applied analysts, I would suggest primarily focusing on the density plots and trace plots for parameters. For the density plots of regression coefficients, these should be roughly normal looking, for variance parameters you may see skewness, especially if the estimate is relatively near zero with smaller data sets. Trace plots in general should look ‘grassy’ or like a ‘fuzzy caterpillar’, which isn’t very helpful, but deviations are usually striking and obvious in my experience. If you see chains that look like they are getting stuck around certain estimates, or separating from one another, this would indicate a problem. If the chains are not converging with one another, you probably already were getting warnings and messages. You can then examine other visualizations that might be appropriate to the problem, and take the appropriate steps outlined to try and solve those issues.</p>
<p>If none of the above solves your problems.</p>
<h2 id="resources">Resources</h2>
<p><a href="https://github.com/stan-dev/stan/wiki/Prior-Choice-Recommendations" class="uri">https://github.com/stan-dev/stan/wiki/Prior-Choice-Recommendations</a></p>
<p><a href="https://mc-stan.org/docs/2_24/reference-manual/divergent-transitions.html" class="uri">https://mc-stan.org/docs/2_24/reference-manual/divergent-transitions.html</a></p>
<p><a href="https://discourse.mc-stan.org/t/divergent-transitions-a-primer/17099" class="uri">https://discourse.mc-stan.org/t/divergent-transitions-a-primer/17099</a></p>
<p><a href="https://mc-stan.org/docs/2_24/reference-manual/effective-sample-size-section.html" class="uri">https://mc-stan.org/docs/2_24/reference-manual/effective-sample-size-section.html</a></p>
<p><a href="https://mc-stan.org/bayesplot/articles/visual-mcmc-diagnostics.html" class="uri">https://mc-stan.org/bayesplot/articles/visual-mcmc-diagnostics.html</a></p>
<p><a href="http://mc-stan.org/cmdstanr/articles/cmdstanr.html">Use CmdStan to save memory</a></p>
<ul>
<li><a href="https://jrnold.github.io/bayesian_notes/">Jeffrey Arnold’s Bayesian Notes</a> has nice examples of many models and good summaries otherwise</li>
</ul>
<section class="footnotes" role="doc-endnotes">
<hr />
<ol>
<li id="fn1" role="doc-endnote"><p>I will spare the details of my opinions, which are almost entirely negative.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2" role="doc-endnote"><p>For this model, they are uniform/improper priors for the regression coefficients and half-t for the residual variance. You can always use <span class="func" style="">prior_summary</span> on a brms model to see this.<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3" role="doc-endnote"><p>With more posterior samples comes slower visualizations and possibly other computations.<a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn4" role="doc-endnote"><p>And I say this as someone with experience detecting funnel clouds.<a href="#fnref4" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn5" role="doc-endnote"><p>I swear sometimes we’re taking a step back in time with some of these plots. All of the diagnostic plots defaults appear to be styles you’d find in Tukey’s EDA from 1950. You don’t necessarily need to get fancy, but surely the defaults could be better.<a href="#fnref5" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn6" role="doc-endnote"><p>In my experience, there isn’t a need to guess between .80 and .99 as the time differences are typically negligble. If it doesn’t work at .99, it won’t at .9999 either.<a href="#fnref6" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn7" role="doc-endnote"><p>It is often suggested in the Stan world to reparameterize models. However, this advice doesn’t really apply in the case of using rstanarm or brms (i.e. where you aren’t writing Stan code directly), and it assumes a level of statistical expertise many would not have, or even if they do, route to respecifying the model may not be obvious.<a href="#fnref7" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn8" role="doc-endnote"><p>Betancourt, whose work I admire greatly, typically makes my head spin.<a href="#fnref8" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section>
<!--radix_placeholder_article_footer-->
<!--/radix_placeholder_article_footer-->
</div>

<div class="d-appendix">
</div>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

<!--radix_placeholder_site_after_body-->
<!--/radix_placeholder_site_after_body-->
<!--radix_placeholder_appendices-->
<div class="appendix-bottom"></div>
<!--/radix_placeholder_appendices-->
<!--radix_placeholder_navigation_after_body-->
<!--/radix_placeholder_navigation_after_body-->

</body>

</html>
