<!DOCTYPE html>
<html >

<head>

  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Engaging the Web with \dots</title>
  <meta content="text/html; charset=UTF-8" http-equiv="Content-Type">
  <meta name="description" content="An introduction to using R for the web.">
  <meta name="generator" content="bookdown 0.1.7 and GitBook 2.6.7">

  <meta property="og:title" content="Engaging the Web with \dots" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="An introduction to using R for the web." />
  <meta name="github-repo" content="m-clark/Workshops" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Engaging the Web with \dots" />
  
  <meta name="twitter:description" content="An introduction to using R for the web." />
  


<meta name="date" content="2016-10-19">

<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  TeX: { equationNumbers: { autoNumber: "AMS" } }
});
</script>

  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  
  
<link rel="prev" href="index.html">
<link rel="next" href="apis.html">

<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />







<script src="libs/htmlwidgets-0.7/htmlwidgets.js"></script>
<link href="libs/plotlyjs-1.16.3/plotly-htmlwidgets.css" rel="stylesheet" />
<script src="libs/plotlyjs-1.16.3/plotly-latest.min.js"></script>
<script src="libs/plotly-binding-4.5.2/plotly.js"></script>
<link href="libs/leaflet-0.7.3/leaflet.css" rel="stylesheet" />
<script src="libs/leaflet-0.7.3/leaflet.js"></script>
<link href="libs/leafletfix-1.0.0/leafletfix.css" rel="stylesheet" />
<script src="libs/leaflet-binding-1.0.1/leaflet.js"></script>


<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
</style>

<link rel="stylesheet" href="webR.css" type="text/css" />
</head>

<body>


  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="https://m-clark.github.io/docs/web/"><span style="font-size:150%; font-variant:small-caps; font-style:italic; color:#ff5503">webR</span></a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Introduction</a><ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#prerequisites"><i class="fa fa-check"></i>Prerequisites</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="web-scraping.html"><a href="web-scraping.html"><i class="fa fa-check"></i>Web scraping</a><ul>
<li class="chapter" data-level="" data-path="web-scraping.html"><a href="web-scraping.html#direct-data-download"><i class="fa fa-check"></i>Direct data download</a></li>
<li class="chapter" data-level="" data-path="web-scraping.html"><a href="web-scraping.html#key-concepts"><i class="fa fa-check"></i>Key concepts</a></li>
<li class="chapter" data-level="" data-path="web-scraping.html"><a href="web-scraping.html#the-basic-approach"><i class="fa fa-check"></i>The basic approach</a></li>
<li class="chapter" data-level="" data-path="web-scraping.html"><a href="web-scraping.html#examples"><i class="fa fa-check"></i>Examples</a><ul>
<li class="chapter" data-level="" data-path="web-scraping.html"><a href="web-scraping.html#tables"><i class="fa fa-check"></i>Tables</a></li>
<li class="chapter" data-level="" data-path="web-scraping.html"><a href="web-scraping.html#text"><i class="fa fa-check"></i>Text</a></li>
<li class="chapter" data-level="" data-path="web-scraping.html"><a href="web-scraping.html#images"><i class="fa fa-check"></i>Images</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="web-scraping.html"><a href="web-scraping.html#issues"><i class="fa fa-check"></i>Issues</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="apis.html"><a href="apis.html"><i class="fa fa-check"></i>APIs</a><ul>
<li class="chapter" data-level="" data-path="apis.html"><a href="apis.html#raw-example"><i class="fa fa-check"></i>Raw Example</a></li>
<li class="chapter" data-level="" data-path="apis.html"><a href="apis.html#r-packages"><i class="fa fa-check"></i>R packages</a><ul>
<li class="chapter" data-level="" data-path="apis.html"><a href="apis.html#new-york-times-article-search"><i class="fa fa-check"></i>New York Times Article Search</a></li>
<li class="chapter" data-level="" data-path="apis.html"><a href="apis.html#wikipedia-1"><i class="fa fa-check"></i>Wikipedia</a></li>
<li class="chapter" data-level="" data-path="apis.html"><a href="apis.html#qualtrics"><i class="fa fa-check"></i>Qualtrics</a></li>
<li class="chapter" data-level="" data-path="apis.html"><a href="apis.html#others"><i class="fa fa-check"></i>Others</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="apis.html"><a href="apis.html#issues-1"><i class="fa fa-check"></i>Issues</a><ul>
<li class="chapter" data-level="" data-path="apis.html"><a href="apis.html#documentation"><i class="fa fa-check"></i>Documentation</a></li>
<li class="chapter" data-level="" data-path="apis.html"><a href="apis.html#api-changes"><i class="fa fa-check"></i>API Changes</a></li>
<li class="chapter" data-level="" data-path="apis.html"><a href="apis.html#broken-api"><i class="fa fa-check"></i>Broken API</a></li>
<li class="chapter" data-level="" data-path="apis.html"><a href="apis.html#restrictions"><i class="fa fa-check"></i>Restrictions</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="" data-path="visualization.html"><a href="visualization.html"><i class="fa fa-check"></i>Visualization</a><ul>
<li class="chapter" data-level="" data-path="visualization.html"><a href="visualization.html#systems"><i class="fa fa-check"></i>Systems</a><ul>
<li class="chapter" data-level="" data-path="visualization.html"><a href="visualization.html#plotly"><i class="fa fa-check"></i>plotly</a></li>
<li class="chapter" data-level="" data-path="visualization.html"><a href="visualization.html#rbokeh"><i class="fa fa-check"></i>rbokeh</a></li>
<li class="chapter" data-level="" data-path="visualization.html"><a href="visualization.html#others-1"><i class="fa fa-check"></i>Others</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="visualization.html"><a href="visualization.html#htmlwidgets"><i class="fa fa-check"></i>htmlwidgets</a><ul>
<li class="chapter" data-level="" data-path="visualization.html"><a href="visualization.html#leaflet-example"><i class="fa fa-check"></i>Leaflet example</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="visualization.html"><a href="visualization.html#shiny"><i class="fa fa-check"></i>Shiny</a><ul>
<li class="chapter" data-level="" data-path="visualization.html"><a href="visualization.html#server"><i class="fa fa-check"></i>Server</a></li>
<li class="chapter" data-level="" data-path="visualization.html"><a href="visualization.html#ui"><i class="fa fa-check"></i>UI</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="visualization.html"><a href="visualization.html#dashboards"><i class="fa fa-check"></i>Dashboards</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="publishing.html"><a href="publishing.html"><i class="fa fa-check"></i>Publishing</a><ul>
<li class="chapter" data-level="" data-path="publishing.html"><a href="publishing.html#publishing-languages"><i class="fa fa-check"></i>Publishing Languages</a><ul>
<li class="chapter" data-level="" data-path="publishing.html"><a href="publishing.html#markdown"><i class="fa fa-check"></i>Markdown</a></li>
<li class="chapter" data-level="" data-path="publishing.html"><a href="publishing.html#r-markdown"><i class="fa fa-check"></i>R Markdown</a></li>
<li class="chapter" data-level="" data-path="publishing.html"><a href="publishing.html#html-css-etc."><i class="fa fa-check"></i>HTML, CSS etc.</a></li>
<li class="chapter" data-level="" data-path="publishing.html"><a href="publishing.html#latex"><i class="fa fa-check"></i>LaTeX</a></li>
<li class="chapter" data-level="" data-path="publishing.html"><a href="publishing.html#yaml"><i class="fa fa-check"></i>YAML</a></li>
<li class="chapter" data-level="" data-path="publishing.html"><a href="publishing.html#pandoc"><i class="fa fa-check"></i>Pandoc</a></li>
<li class="chapter" data-level="" data-path="publishing.html"><a href="publishing.html#summary"><i class="fa fa-check"></i>Summary</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="publishing.html"><a href="publishing.html#document-formats"><i class="fa fa-check"></i>Document Formats</a><ul>
<li class="chapter" data-level="" data-path="publishing.html"><a href="publishing.html#html"><i class="fa fa-check"></i>HTML</a></li>
<li class="chapter" data-level="" data-path="publishing.html"><a href="publishing.html#notebooks"><i class="fa fa-check"></i>Notebooks</a></li>
<li class="chapter" data-level="" data-path="publishing.html"><a href="publishing.html#print"><i class="fa fa-check"></i>Print</a></li>
<li class="chapter" data-level="" data-path="publishing.html"><a href="publishing.html#journals"><i class="fa fa-check"></i>Journals</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="publishing.html"><a href="publishing.html#presentations"><i class="fa fa-check"></i>Presentations</a></li>
<li class="chapter" data-level="" data-path="publishing.html"><a href="publishing.html#other-formats"><i class="fa fa-check"></i>Other formats</a></li>
<li class="chapter" data-level="" data-path="publishing.html"><a href="publishing.html#other"><i class="fa fa-check"></i>Other</a><ul>
<li class="chapter" data-level="" data-path="publishing.html"><a href="publishing.html#customization"><i class="fa fa-check"></i>Customization</a></li>
<li class="chapter" data-level="" data-path="publishing.html"><a href="publishing.html#rpubs"><i class="fa fa-check"></i>Rpubs</a></li>
<li class="chapter" data-level="" data-path="publishing.html"><a href="publishing.html#more"><i class="fa fa-check"></i>More</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="" data-path="conclusion.html"><a href="conclusion.html"><i class="fa fa-check"></i>Conclusion</a></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
<li class="divider"></li>
<li><a href="https://m-clark.github.io" target="blank" style="font-size:150%; font-variant:small-caps; color:#ff5500">Michael Clark</a></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank" style="font-size:75%;">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./"><span style="font-size:150%; font-variant:small-caps; font-style:italic; color:#1e90ff">Engaging the Web with <span class="math inline">\(\dots\)</span></span></a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="web-scraping" class="section level1">
<h1>Web scraping</h1>
<p>We begin with a discussion on <span class="emph">web scraping</span>. The term itself is ambiguous, and could potentially mean anything<a href="#fn1" class="footnoteRef" id="fnref1"><sup>1</sup></a>, but the gist is that there is something out on the web (or some connected machine) that we want, and we’d like to use R to get it. This section won’t (at least for now) get into lower level utilities such as that provided by <span class="pack">httr</span> or <span class="pack">Rcurl</span>, though some packages will be using them under the hood. Instead, focus will be on higher-level approaches with an eye toward common tasks.</p>
<p>As a starting point, open a browser and go to a website of your preference. For most browsers, Ctrl+U will open up the underlying html file. If you’re on a typical webpage it will almost certainly look like a mess of <span class="emph">html</span>, <span class="emph">JavaScript</span>, <span class="emph">XML</span> and possibly other things. Simpler pages are more easily discernible, while more complex/secure pages are not. The take home message is that what you want is represented by something in there, and you’ll have to know something about that structure in order to get it.</p>
<p>Unfortunately, a lot of web design is quite poor<a href="#fn2" class="footnoteRef" id="fnref2"><sup>2</sup></a>, which will make your job difficult. Even when the sole purpose of a site is to provide data, you can almost be sure that the simplest/most flexible path will not be taken to do so. Thankfully you can use R and possibly other tools to make the process at least somewhat less painful.</p>
<div id="direct-data-download" class="section level2">
<h2>Direct data download</h2>
<p>One thing to be aware of is that you can get data from the web that are in typical formats just as you would any file on your own machine. For example:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">mydata =<span class="st"> </span><span class="kw">read.csv</span>(<span class="st">&#39;http://somewebsite/data.csv&#39;</span>)</code></pre></div>
<p>I wouldn’t even call this web scraping, just as you wouldn’t if you were getting a file off a network connection. However, if you’re just starting out with R, it’s important to know this is possible. In any case, do not make things more difficult than they need to be- if the file is available just grab it.</p>
</div>
<div id="key-concepts" class="section level2">
<h2>Key concepts</h2>
<p>The web works in mysterious ways, but you don’t have to know a lot about it to use it or benefit from its data. Many people have had their own websites for years without knowing any html. For our purposes, it helps to know a little and is actually required, at least so that we know what to look for.</p>
<p>Common <a href="https://en.wikipedia.org/wiki/HTML_element">elements</a> or <span class="emph">tags</span><a href="#fn3" class="footnoteRef" id="fnref3"><sup>3</sup></a> of a webpage include things like <code>div</code> <code>table</code> and <code>ul</code> and <code>body</code>, and within such things our data will be found. Some common ones include:</p>
<ul>
<li><code>div</code> and <code>span</code>: used when other elements are not appropriate but one still wants to define classes, ids etc.</li>
<li><code>p</code> paragraph</li>
<li><code>a</code> link (technically ‘anchor’)</li>
<li><code>ul</code> <code>ol</code> lists</li>
<li><code>table</code> <code>tr</code> <code>td</code> tables, table rows, table data (cell)</li>
<li><code>h#</code> i.e. <code>h1</code> <code>h2</code> etc. headers</li>
<li><code>img</code> images</li>
</ul>
<p>Consider the following:</p>
<div class="sourceCode"><pre class="sourceCode html"><code class="sourceCode html"><span class="kw">&lt;h3&gt;</span> This header denotes a section of text

<span class="kw">&lt;img</span><span class="ot"> src=</span><span class="st">&quot;picture_of_cat.png&quot;</span><span class="kw">&gt;&lt;/img&gt;</span>

<span class="kw">&lt;p&gt;</span> This is a  paragraph! <span class="kw">&lt;/p&gt;</span>

<span class="kw">&lt;p&gt;</span> Here is another! This one has <span class="kw">&lt;a</span><span class="ot"> href=</span><span class="st">&quot;www.someurl.com&quot;</span><span class="kw">&gt;</span>a link<span class="kw">&lt;/a&gt;</span>! <span class="kw">&lt;/p&gt;</span></code></pre></div>
<p>As an example, if we wanted to scrape every paragraph that had the word paragraph in it, we’d need to first get all the <code>&lt;p&gt;</code> elements and work from there.</p>
<p>Just like in other programming languages, these parts of a webpage have their own <span class="emph">class</span>, e.g. <code>&lt;table class=&quot;wikitable sortable&quot;&gt;</code>, and this allows even easier access to the objects of specific interest. Take a look at the source for the Wikipedia page for <a href="https://en.wikipedia.org/wiki/List_of_cities,_villages,_and_townships_in_Michigan">towns in Michigan</a>.</p>
<p><img src="img/mich_town_wiki.png" style="display:block; margin: 0 auto;"></p>
<p>The <span class="emph">id</span> is another <span class="emph">attribute</span>, or way to note specific types of objects. Unlike classes, which might be used over and over within a page, ids are unique, and thus for web scraping, probably more useful when appropriate to the task. Also, while elements can have multiple classes, they can have only one id. Any particular element might also have different attributes that specify things like style, alignment, color, file source etc.</p>
<p>The sad thing is that attributes are greatly underutilized in general. For example, perhaps you found a page with several html tables of data, one for each year. It would have been simple to add an <code>id = year</code> to each one, enabling you to grab just the specific year(s) of interest, but it’ll be rare that you’d find a page that goes that far. Part of this could be due to the fact that much content is auto-generated via WYSIWYG editors, but these are not very professional pages if so, which might cause concern for the data given such a source. Take a look at the <a href="openfda.gov" class="uri">openfda.gov</a> site:</p>
<p><img src="img/openfda.png" style="display:block; margin: 0 auto;"></p>
<p>It has lots of attributes for practically every element, which would make getting stuff off the page fairly easy, if it didn’t already have an <a href="apis.html#apis">APIs</a>.</p>
<p>In any case, you’ll at least need to know the tag within which the data or link to it may be found. Classes and ids will help to further drill down the web page content, but often won’t be available. In such a case you might have to grab, for example, all the links, and then use some <span class="emph">regular expression</span> to grab only the one you want. See this <a href="https://en.wikipedia.org/wiki/HTML_attribute">link</a> for more on relations between attributes and elements.</p>
</div>
<div id="the-basic-approach" class="section level2">
<h2>The basic approach</h2>
<p>To summarize the basic approach, we can outline a few steps:</p>
<ol start="0" style="list-style-type: decimal">
<li>If a direct link or API is available use it<a href="#fn4" class="footnoteRef" id="fnref4"><sup>4</sup></a></li>
<li>Inspect the page to find the relevant tags within which the content is found</li>
<li>Start with a base URL</li>
<li>Use the relevant R packages to parse the base page</li>
<li>Extract the desired content</li>
</ol>
</div>
<div id="examples" class="section level2">
<h2>Examples</h2>
<p>One of the packages that can make scraping easy is <span class="pack">rvest</span>, which is modeled after/inspired by the <span class="pack">Beautiful Soup</span> module in Python<a href="#fn5" class="footnoteRef" id="fnref5"><sup>5</sup></a>. As the goal here is to get you quickly started, we won’t inundate you with a lot of packages yet. I recommend getting comfy with <span class="pack">rvest</span> and moving to others when needed.</p>
<div id="tables" class="section level3">
<h3>Tables</h3>
<div id="wikipedia" class="section level4">
<h4>Wikipedia</h4>
<p>A lot of Wikipedia has pages ripe for the scraping, but it also has an API, so that we can use it as an example later as well. Between the page layout and <span class="pack">rvest</span> it will be very easy to get the content. So let’s do so. Back to the page of towns in Michigan. Let’s see if we can get the table of towns with their type, county, and population. First things first, we need to get the page.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">page =<span class="st"> &#39;https://en.wikipedia.org/wiki/List_of_cities,_villages,_and_townships_in_Michigan&#39;</span>

<span class="kw">library</span>(rvest)

towns =<span class="st"> </span><span class="kw">read_html</span>(page)
<span class="kw">str</span>(towns)</code></pre></div>
<pre><code>List of 2
 $ node:&lt;externalptr&gt; 
 $ doc :&lt;externalptr&gt; 
 - attr(*, &quot;class&quot;)= chr [1:2] &quot;xml_document&quot; &quot;xml_node&quot;</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">towns</code></pre></div>
<pre><code>{xml_document}
&lt;html class=&quot;client-nojs&quot; lang=&quot;en&quot; dir=&quot;ltr&quot;&gt;
[1] &lt;head&gt;\n  &lt;meta charset=&quot;UTF-8&quot;/&gt;\n  &lt;title&gt;List of cities, villages, and townships in Michigan - Wikipedia, the  ...
[2] &lt;body class=&quot;mediawiki ltr sitedir-ltr mw-hide-empty-elt ns-0 ns-subject page-List_of_cities_villages_and_townshi ...</code></pre>
<p>The result of <span class="func">read_html</span> is an <span class="objclass">xml_document</span> class object. For the uninitiated, XML is a markup language (Extensible Markup Language) like HTML, and which allows one to access its parts as nodes in tree<a href="#fn6" class="footnoteRef" id="fnref6"><sup>6</sup></a>, where <em>parents</em> have <em>children</em> and <em>grandchildren</em> etc. It will require further parsing in order to get what we want, but it was easy enough to snag the page. Let’s look at some of the nodes.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">html_nodes</span>(towns, <span class="st">&#39;ul&#39;</span>) %&gt;%<span class="st"> </span>head   <span class="co"># unordered lists (first few)</span></code></pre></div>
<pre><code>{xml_nodeset (6)}
[1] &lt;ul&gt;&lt;li&gt;&lt;a href=&quot;#A&quot;&gt;A&lt;/a&gt;&lt;/li&gt;\n&lt;li&gt;&lt;a href=&quot;#B&quot;&gt;B&lt;/a&gt;&lt;/li&gt;\n&lt;li&gt;&lt;a href=&quot;#C&quot;&gt;C&lt;/a&gt;&lt;/li&gt;\n&lt;li&gt;&lt;a href=&quot;#D&quot;&gt;D&lt;/a&gt; ...
[2] &lt;ul&gt;&lt;li&gt;&lt;a href=&quot;#See_also&quot;&gt;See also&lt;/a&gt;&lt;/li&gt;\n&lt;li&gt;&lt;a href=&quot;#References&quot;&gt;References&lt;/a&gt;&lt;/li&gt;\n&lt;li&gt;&lt;a href=&quot;#Exter ...
[3] &lt;ul&gt;&lt;li&gt;&lt;a href=&quot;/wiki/Administrative_divisions_of_Michigan&quot; title=&quot;Administrative divisions of Michigan&quot;&gt;Adminis ...
[4] &lt;ul&gt;&lt;li&gt;&lt;a rel=&quot;nofollow&quot; class=&quot;external text&quot; href=&quot;https://web.archive.org/web/20040908085409/http://www.vienn ...
[5] &lt;ul&gt;&lt;li&gt;&lt;a rel=&quot;nofollow&quot; class=&quot;external text&quot; href=&quot;http://www.census.gov/geo/www/gazetteer/places2k.html&quot;&gt;Cens ...
[6] &lt;ul&gt;&lt;li class=&quot;nv-view&quot;&gt;&lt;a href=&quot;/wiki/Template:Michigan&quot; title=&quot;Template:Michigan&quot;&gt;&lt;abbr title=&quot;View this templa ...</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">html_nodes</span>(towns, <span class="st">&#39;a&#39;</span>) %&gt;%<span class="st"> </span>head    <span class="co"># links </span></code></pre></div>
<pre><code>{xml_nodeset (6)}
[1] &lt;a id=&quot;top&quot;/&gt;
[2] &lt;a href=&quot;#mw-head&quot;&gt;navigation&lt;/a&gt;
[3] &lt;a href=&quot;#p-search&quot;&gt;search&lt;/a&gt;
[4] &lt;a href=&quot;/wiki/Wikipedia:Citing_sources&quot; title=&quot;Wikipedia:Citing sources&quot;&gt;list of references&lt;/a&gt;
[5] &lt;a href=&quot;/wiki/Wikipedia:External_links&quot; title=&quot;Wikipedia:External links&quot;&gt;external links&lt;/a&gt;
[6] &lt;a href=&quot;/wiki/Wikipedia:Citing_sources#Inline_citations&quot; title=&quot;Wikipedia:Citing sources&quot;&gt;inline citations&lt;/a&gt;</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">html_nodes</span>(towns, <span class="st">&#39;table&#39;</span>)         <span class="co"># tables</span></code></pre></div>
<pre><code>{xml_nodeset (5)}
[1] &lt;table class=&quot;plainlinks metadata ambox ambox-style ambox-No_footnotes&quot; role=&quot;presentation&quot;&gt;\n  &lt;tr&gt;&lt;td class=&quot;mb ...
[2] &lt;table class=&quot;wikitable sortable&quot;&gt;\n  &lt;tr&gt;&lt;th&gt;Place&lt;/th&gt;\n&lt;th&gt;Type&lt;/th&gt;\n&lt;th&gt;County&lt;/th&gt;\n&lt;th&gt;2010 Population&lt;/th ...
[3] &lt;table role=&quot;presentation&quot; class=&quot;mbox-small plainlinks sistersitebox&quot; style=&quot;border:1px solid #aaa;background-co ...
[4] &lt;table class=&quot;nowraplinks collapsible autocollapse navbox-inner&quot; style=&quot;border-spacing:0;background:transparent;c ...
[5] &lt;table class=&quot;nowraplinks collapsible autocollapse navbox-inner&quot; style=&quot;border-spacing:0;background:transparent;c ...</code></pre>
<p>Perhaps now you are getting a sense of what we can possibly extract from this page. It turns out that what we want is a table element, and in particular, the one that is of class <code>wikitable sortable</code>. This will make things very easy. But what if we didn’t know what the element was? it turns out there are tools like <a href="http://selectorgadget.com">SelectorGadget</a><a href="#fn7" class="footnoteRef" id="fnref7"><sup>7</sup></a> that can be used to inspect the elements of any webpage. SelectorGadget can be added as a browser extension, which would allow you to easily turn it on and off as needed. The following depicts what the Michigan towns looks like when using SelectorGadget and selecting a link.</p>
<p><img src="img/selectorgadget.png" style="display:block; margin: 0 auto;"></p>
<p>It highlights everything else in the page that is of a similar type (i.e. other links), as well as provides the css/xml info that we would need to grab that particular item.</p>
<p>As mentioned, we want the <code>wikitable sortable</code> class table, so lets grab that. The <span class="pack">rvest</span> package comes with the <span class="func">html_table</span> function, that will grab any table and attempt to put it into a data.frame object. I only show the first couple because one of the tables comes out pretty messy at the R console.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">str</span>(<span class="kw">html_table</span>(towns)[<span class="dv">1</span>:<span class="dv">3</span>])</code></pre></div>
<pre><code>List of 3
 $ :&#39;data.frame&#39;:   1 obs. of  2 variables:
  ..$ X1: logi NA
  ..$ X2: chr &quot;This article includes a list of references, related reading or external links, but its sources remain unclear because it lacks &quot;| __truncated__
 $ :&#39;data.frame&#39;:   2185 obs. of  4 variables:
  ..$ Place          : chr [1:2185] &quot;Acme&quot; &quot;Acme Township&quot; &quot;Ada Township&quot; &quot;Adams Township, Arenac County&quot; ...
  ..$ Type           : chr [1:2185] &quot;unincorporated community&quot; &quot;township&quot; &quot;township&quot; &quot;township&quot; ...
  ..$ County         : chr [1:2185] &quot;&quot; &quot;&quot; &quot;Kent&quot; &quot;Arenac&quot; ...
  ..$ 2010 Population: chr [1:2185] &quot;&quot; &quot;4,375&quot; &quot;13,142&quot; &quot;563&quot; ...
 $ :&#39;data.frame&#39;:   1 obs. of  2 variables:
  ..$ X1: logi NA
  ..$ X2: chr &quot;Wikimedia Commons has media related to Populated places in Michigan.&quot;</code></pre>
<p>We know which class object we want though, so we could have used <span class="func">html_nodes</span> to grab <em>only</em> that object and work with it.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">html_nodes</span>(towns, <span class="st">&#39;.wikitable.sortable&#39;</span>) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">html_table</span>() %&gt;%<span class="st"> </span>
<span class="st">  </span>.[[<span class="dv">1</span>]] %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">head</span>()</code></pre></div>
<pre><code>                             Place                     Type    County 2010 Population
1                             Acme unincorporated community                          
2                    Acme Township                 township                     4,375
3                     Ada Township                 township      Kent          13,142
4    Adams Township, Arenac County                 township    Arenac             563
5 Adams Township, Hillsdale County                 township Hillsdale           2,493
6  Adams Township, Houghton County                 township  Houghton           2,573</code></pre>
<p>Here the <code>.</code> in <code>.wikitable.sortable</code> represents the class/subclass (use <code>#</code> for ids). In general though, if you know it’s a table, then use <span class="func">html_table</span>. When the table has no class then you’ll have to use a magic number or some other means to grab it, which may not be as robust. Of course, the class itself might change over time also.</p>
<p>So let’s put this all together.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(stringr)
towns %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">html_table</span>() %&gt;%<span class="st"> </span>
<span class="st">  </span>.[[<span class="dv">2</span>]] %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">rename</span>(<span class="dt">Population =</span> <span class="st">`</span><span class="dt">2010 Population</span><span class="st">`</span>) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">Population =</span> <span class="kw">strtoi</span>(<span class="kw">str_replace_all</span>(Population, <span class="st">&#39;,&#39;</span>, <span class="st">&#39;&#39;</span>)),
         <span class="dt">Type =</span> <span class="kw">factor</span>(Type)) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(!Type %in%<span class="st"> </span><span class="kw">c</span>(<span class="st">&#39;unincorporated community&#39;</span>, <span class="st">&#39;CDP&#39;</span>)) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x=</span>Population, <span class="dt">fill=</span>Type, <span class="dt">color=</span>Type)) +
<span class="st">  </span><span class="kw">scale_x_log10</span>() +
<span class="st">  </span><span class="kw">geom_density</span>(<span class="dt">alpha=</span>.<span class="dv">2</span>) +
<span class="st">  </span><span class="kw">theme</span>(<span class="dt">panel.background=</span><span class="kw">element_rect</span>(<span class="dt">fill=</span><span class="st">&#39;transparent&#39;</span>, <span class="dt">color=</span><span class="ot">NA</span>),
        <span class="dt">plot.background=</span><span class="kw">element_rect</span>(<span class="dt">fill=</span><span class="st">&#39;transparent&#39;</span>, <span class="dt">color=</span><span class="ot">NA</span>))</code></pre></div>
<p><img src="webR_files/figure-html/wikitableGraph-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>I won’t go into details about the rest of the code regarding data processing, as that’s for another <a href="http://m-clark.github.io/workshops/dplyr/mainSlides.html">workshop</a>. For now it suffices to say that it didn’t take much to go from URL to visualization.</p>
</div>
<div id="basketball-reference" class="section level4">
<h4>Basketball Reference</h4>
<p>As an additional example let’s get some data from <a href="http://www.basketball-reference.com/">basketball-reference.com</a>. The following gets the totals table from the URL<a href="#fn8" class="footnoteRef" id="fnref8"><sup>8</sup></a>. Issues include header rows after every 20<sup>th</sup> row of data, and converting all but a few columns from character to numeric.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">url =<span class="st"> &quot;http://www.basketball-reference.com/leagues/NBA_2016_totals.html&quot;</span>
bball =<span class="st"> </span><span class="kw">read_html</span>(url) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">html_node</span>(<span class="st">&quot;#totals_stats&quot;</span>) %&gt;%<span class="st">                       </span><span class="co"># grab element with id &#39;total_stats&#39;</span>
<span class="st">  </span><span class="kw">html_table</span>() %&gt;%<span class="st">                                     </span><span class="co"># the data</span>
<span class="st">  </span><span class="kw">filter</span>(Rk !=<span class="st"> &quot;Rk&quot;</span>) %&gt;%<span class="st">                               </span><span class="co"># remove header rows</span>
<span class="st">  </span><span class="kw">mutate_at</span>(<span class="kw">vars</span>(-Player, -Pos, -Tm), as.numeric)      <span class="co"># convert to numeric</span>

<span class="kw">str</span>(bball)</code></pre></div>
<pre><code>&#39;data.frame&#39;:   578 obs. of  30 variables:
 $ Rk    : num  1 2 3 4 5 6 7 8 9 10 ...
 $ Player: chr  &quot;Quincy Acy&quot; &quot;Jordan Adams&quot; &quot;Steven Adams&quot; &quot;Arron Afflalo&quot; ...
 $ Pos   : chr  &quot;PF&quot; &quot;SG&quot; &quot;C&quot; &quot;SG&quot; ...
 $ Age   : num  25 21 22 30 27 27 30 20 26 34 ...
 $ Tm    : chr  &quot;SAC&quot; &quot;MEM&quot; &quot;OKC&quot; &quot;NYK&quot; ...
 $ G     : num  59 2 80 71 59 60 74 8 79 64 ...
 $ GS    : num  29 0 80 57 17 5 74 0 28 57 ...
 $ MP    : num  876 15 2014 2371 861 ...
 $ FG    : num  119 2 261 354 150 134 536 5 191 215 ...
 $ FGA   : num  214 6 426 799 315 ...
 $ FG%   : num  0.556 0.333 0.613 0.443 0.476 0.596 0.513 0.5 0.516 0.458 ...
 $ 3P    : num  19 0 0 91 0 0 0 0 0 15 ...
 $ 3PA   : num  49 1 0 238 1 0 16 0 0 42 ...
 $ 3P%   : num  0.388 0 NA 0.382 0 NA 0 NA NA 0.357 ...
 $ 2P    : num  100 2 261 263 150 134 536 5 191 200 ...
 $ 2PA   : num  165 5 426 561 314 ...
 $ 2P%   : num  0.606 0.4 0.613 0.469 0.478 0.596 0.521 0.5 0.516 0.468 ...
 $ eFG%  : num  0.6 0.333 0.613 0.5 0.476 0.596 0.513 0.5 0.516 0.474 ...
 $ FT    : num  50 3 114 110 52 60 259 0 46 90 ...
 $ FTA   : num  68 5 196 131 62 84 302 0 73 138 ...
 $ FT%   : num  0.735 0.6 0.582 0.84 0.839 0.714 0.858 NA 0.63 0.652 ...
 $ ORB   : num  65 0 219 23 75 86 176 2 162 104 ...
 $ DRB   : num  123 2 314 243 194 202 456 4 262 192 ...
 $ TRB   : num  188 2 533 266 269 288 632 6 424 296 ...
 $ AST   : num  27 3 62 144 31 50 110 0 76 70 ...
 $ STL   : num  29 3 42 25 19 47 38 1 26 110 ...
 $ BLK   : num  24 0 89 10 36 68 81 2 42 18 ...
 $ TOV   : num  27 2 84 82 54 64 99 1 69 78 ...
 $ PF    : num  103 2 223 142 134 139 151 1 147 175 ...
 $ PTS   : num  307 7 636 909 352 ...</code></pre>
</div>
</div>
<div id="text" class="section level3">
<h3>Text</h3>
<p>A lot of times we’ll want to grab text as opposed to tables. See the <a href="apis.html#apis">API chapter</a> for an example, and the <span class="func">html_text</span> function in the <span class="pack">rvest</span> package.</p>
</div>
<div id="images" class="section level3">
<h3>Images</h3>
<p>Images are fairly easy because they are simply files with specific extensions like <code>svg</code>, <code>png</code>, <code>gif</code> etc. In that sense, if one knows the actual location of the image already, a function like <span class="func">download.files</span> can be used to grab it directly. Other times it may not be known, and so we can use a similar approach as before to grab the file.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">base_page =<span class="st"> </span><span class="kw">read_html</span>(<span class="st">&#39;https://en.wikipedia.org/wiki/Main_Page&#39;</span>)
picofday_location =<span class="st"> </span>base_page %&gt;%<span class="st">    </span><span class="co"># get the main page</span>
<span class="st">  </span><span class="kw">html_nodes</span>(<span class="st">&#39;#mp-tfp&#39;</span>) %&gt;%<span class="st">          </span><span class="co"># extract the div with &#39;today&#39;s featured picture&#39;, i.e. tfp</span>
<span class="st">  </span><span class="kw">html_nodes</span>(<span class="st">&#39;img&#39;</span>) %&gt;%<span class="st">              </span><span class="co"># extract the img</span>
<span class="st">  </span><span class="kw">html_attr</span>(<span class="st">&#39;src&#39;</span>)                   <span class="co"># grab the source location</span></code></pre></div>
<p>With location in hand we can now download the file, and even display it in R. The following requires the <span class="pack">grid</span> and <span class="pack">jpeg</span> packages.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">download.file</span>(<span class="dt">url=</span><span class="kw">paste0</span>(<span class="st">&#39;https:&#39;</span>, picofday_location), <span class="dt">destfile=</span><span class="st">&#39;img/picofday.jpg&#39;</span>, <span class="dt">mode=</span><span class="st">&#39;wb&#39;</span>)
picofday =<span class="st"> </span>jpeg::<span class="kw">readJPEG</span>(<span class="dt">source=</span><span class="st">&#39;img/picofday.jpg&#39;</span>)

df =<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">x=</span><span class="kw">rnorm</span>(<span class="dv">1</span>), <span class="dt">y=</span><span class="kw">rnorm</span>(<span class="dv">1</span>))  <span class="co"># note that any random df will suffice</span>

<span class="kw">qplot</span>(<span class="dt">data=</span>df, <span class="dt">geom=</span><span class="st">&#39;blank&#39;</span>) +<span class="st">                </span>
<span class="st">  </span><span class="kw">annotation_custom</span>(grid::<span class="kw">rasterGrob</span>(picofday)) +
<span class="st">  </span><span class="kw">theme_void</span>()</code></pre></div>
<p><img src="webR_files/figure-html/download_show_image-1.png" width="192" style="display: block; margin: auto;" /></p>
<p>Note that an alternative approach that might work on some websites would be to extract all the images and then the one with a relevant naming convention. This doesn’t work for the Wikipedia main page because there is nothing to identify which image is the featured picture by file name alone.</p>
</div>
</div>
<div id="issues" class="section level2">
<h2>Issues</h2>
<p>As mentioned, the ease with which you will be able to scrape a website will depend a lot on how well the page/site is put together. Many are cookie-cutter templates designed with no regard to data availability whatsoever, others are just the result of amateurs that do not do web design for a living, and still others are just poorly designed. In addition, some websites may have security or other server back end things to consider that require much of the content to not be made easily available, perhaps intentionally.</p>
<p>On the other hand, other sites will make it as easy as a URL pointing to a csv file, or an API that is easily maneuverable. The main thing is that you must plan ahead for it to either not be easy to get, and/or to be ready for heavy post-processing even when you get the bulk of what you want. The goal should be to make the process automatic such that only a fundamental site or API change will cause you to have to change your code again.</p>

</div>
</div>
<div class="footnotes">
<hr />
<ol start="1">
<li id="fn1"><p>Called by various names: web harvesting, data scraping (presumptuous), etc.<a href="web-scraping.html#fnref1">↩</a></p></li>
<li id="fn2"><p>Think about your R code, now remove the spaces, indent as irregularly as possible, do not comment anything, use reserved words for common names, don’t name important parts of your site, reject any known coding style, and use default settings. That would describe about 99% of the typical website design I come across.<a href="web-scraping.html#fnref2">↩</a></p></li>
<li id="fn3"><p>There is subtle distinction between <a href="https://en.wikipedia.org/wiki/HTML_element#Elements_vs._tags">tags versus elements</a>, but which won’t really matter to us.<a href="web-scraping.html#fnref3">↩</a></p></li>
<li id="fn4"><p>APIs change so regularly that in some cases it might be easier to scrape as above, especially if the site itself changes relatively rarely and still allows direct access to the desired content.<a href="web-scraping.html#fnref4">↩</a></p></li>
<li id="fn5"><p>I highly recommend <a href="https://www.crummy.com/software/BeautifulSoup/">Beautiful Soup</a> also. Until <span class="pack">rvest</span> and related packages came along, I preferred using Beautiful Soup to what was available in R.<a href="web-scraping.html#fnref5">↩</a></p></li>
<li id="fn6"><p>Think graphical models rather than spruce.<a href="web-scraping.html#fnref6">↩</a></p></li>
<li id="fn7"><p>The openfda site was depicted using the Mozilla firebug extension.<a href="web-scraping.html#fnref7">↩</a></p></li>
<li id="fn8"><p>Technically this data can be downloaded as a supplied csv.<a href="web-scraping.html#fnref8">↩</a></p></li>
</ol>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="index.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="apis.html" class="navigation navigation-next " aria-label="Next page""><i class="fa fa-angle-right"></i></a>

<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script>
require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"facebook": false,
"twitter": false,
"google": false,
"weibo": false,
"instapper": false,
"vk": false,
"all": ["facebook", "google", "twitter", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": false,
"download": null,
"toc": {
"collapse": "subsection"
},
"highlight": "pygments",
"search": true
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    if (location.protocol !== "file:" && /^https?:/.test(script.src))
      script.src  = script.src.replace(/^https?:/, '');
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
